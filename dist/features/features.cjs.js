"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("../shared/make.cjs2.js"),C=require("../shared/mergeItemsSource.cjs.js"),g=(e,a,s)=>e.reduce((o,n)=>(n.code!==m.CHANGE_ARMORS&&n.code!==m.CHANGE_ITEMS&&n.code!==m.CHANGE_WEAPONS||o.push(_(n,a,s)),o),[]),B={[m.CHANGE_WEAPONS]:"weapon",[m.CHANGE_ARMORS]:"armor",[m.CHANGE_ITEMS]:"item"},_=(e,a,s)=>{const o=e.parameters[3]===m.OPERAND_DIRECT?{direct:!0,value:e.parameters[2]}:{direct:!1,variableId:e.parameters[2]},n=e.parameters[0]===m.OPERATION_GAIN?a.gain:e.parameters[0]===m.OPERATION_LOSE?a.lose:a.unknown,t=typeof e.parameters[4]=="boolean"?{includesEquip:e.parameters[4]}:{};return{itemKind:B[e.code],dataId:e.parameters[1],code:e.code,commandNameMZ:s(e.code),operation:n,...t,...o}},R=e=>!!e,S=(e,a)=>e.pages.map((s,o)=>a(s,o,e)),O=(e,a)=>e.events.filter(R).flatMap(s=>S(s,a)),F=e=>e.conditions.itemId>0&&e.conditions.itemValid?{pageCondition:{itemId:e.conditions.itemId}}:{},r=(e,a)=>{const s=e.trimEnd(),o=a.get(s);return o?o.trimEnd():s},p=(e,a,s=`
`)=>m.replaceNote(e.note,o=>r(o.value,a),s),E=(e,a)=>{const s=p(e,a),o=r(e.name,a),n=r(e.description,a);return{...e,name:o,description:n,note:s}},u=(e,a)=>e.map(s=>{switch(s.code){case m.SHOW_MESSAGE:return v(s,a);case m.SHOW_CHOICES:return f(s,a);case m.SHOW_MESSAGE_BODY:case m.COMMENT_HEAD:case m.COMMENT_BODY:case m.SHOW_SCROLLING_TEXT_BODY:return A(s,a);case m.CHANGE_NAME:case m.CHANGE_NICKNAME:case m.CHANGE_PROFILE:return b(s,a);default:return s}}),A=(e,a)=>{const s=r(e.parameters[0],a);return{code:e.code,indent:e.indent,parameters:[s]}},v=(e,a)=>{const s=e.parameters[4]?r(e.parameters[4],a):"";return m.makeCommandShowMessage({facename:e.parameters[0],faceIndex:e.parameters[1],background:e.parameters[2],positionType:e.parameters[3],speakerName:s},e.indent)},b=(e,a)=>{const s=r(e.parameters[1],a);return{code:e.code,indent:e.indent,parameters:[e.parameters[0],s]}},f=(e,a)=>{const s=e.parameters[0].map(o=>r(o,a));return{code:m.SHOW_CHOICES,indent:e.indent,parameters:[s,e.parameters[1],e.parameters[2],e.parameters[3],e.parameters[4]]}},h=(e,a)=>({params:w(e.params,a),messages:W(e.messages,a),commands:k(e.commands,a),basic:L(e.basic,a)}),L=(e,a)=>[r(e[0],a),r(e[1],a),r(e[2],a),r(e[3],a),r(e[4],a),r(e[5],a),r(e[6],a),r(e[7],a),r(e[8],a),r(e[9],a)],k=(e,a)=>[r(e[0],a),r(e[1],a),r(e[2],a),r(e[3],a),r(e[4],a),r(e[5],a),r(e[6],a),r(e[7],a),r(e[8],a),r(e[9],a),r(e[10],a),r(e[11],a),r(e[12],a),r(e[13],a),r(e[14],a),r(e[15],a),r(e[16],a),r(e[17],a),r(e[18],a),r(e[19],a),"",r(e[21],a),r(e[22],a),"",r(e[24],a),r(e[25],a)],w=(e,a)=>[r(e[0],a),r(e[1],a),r(e[2],a),r(e[3],a),r(e[4],a),r(e[5],a),r(e[6],a),r(e[7],a),r(e[8],a),r(e[9],a)],W=(e,a)=>({actionFailure:r(e.actionFailure,a),actorDamage:r(e.actorDamage,a),actorDrain:r(e.actorDrain,a),actorGain:r(e.actorGain,a),actorLoss:r(e.actorLoss,a),actorNoDamage:r(e.actorNoDamage,a),actorNoHit:r(e.actorNoHit,a),actorRecovery:r(e.actorRecovery,a),alwaysDash:r(e.alwaysDash,a),autosave:r(e.autosave,a),bgmVolume:r(e.bgmVolume,a),bgsVolume:r(e.bgsVolume,a),buffAdd:r(e.buffAdd,a),buffRemove:r(e.buffRemove,a),commandRemember:r(e.commandRemember,a),counterAttack:r(e.counterAttack,a),criticalToActor:r(e.criticalToActor,a),criticalToEnemy:r(e.criticalToEnemy,a),defeat:r(e.defeat,a),debuffAdd:r(e.debuffAdd,a),emerge:r(e.emerge,a),enemyDamage:r(e.enemyDamage,a),enemyDrain:r(e.enemyDrain,a),enemyGain:r(e.enemyGain,a),enemyLoss:r(e.enemyLoss,a),enemyNoDamage:r(e.enemyNoDamage,a),enemyNoHit:r(e.enemyNoHit,a),enemyRecovery:r(e.enemyRecovery,a),escapeFailure:r(e.escapeFailure,a),escapeStart:r(e.escapeStart,a),evasion:r(e.evasion,a),expNext:r(e.expNext,a),expTotal:r(e.expTotal,a),file:r(e.file,a),loadMessage:r(e.loadMessage,a),levelUp:r(e.levelUp,a),magicEvasion:r(e.magicEvasion,a),magicReflection:r(e.magicReflection,a),meVolume:r(e.meVolume,a),obtainExp:r(e.obtainExp,a),obtainGold:r(e.obtainGold,a),obtainItem:r(e.obtainItem,a),obtainSkill:r(e.obtainSkill,a),partyName:r(e.partyName,a),possession:r(e.possession,a),preemptive:r(e.preemptive,a),saveMessage:r(e.saveMessage,a),seVolume:r(e.seVolume,a),substitute:r(e.substitute,a),surprise:r(e.surprise,a),touchUI:r(e.touchUI,a),useItem:r(e.useItem,a),victory:r(e.victory,a)}),l=(e,a)=>e.map(s=>r(s,a)),M=e=>e.map(a=>a.parameters[0].trimEnd()).join(`
`).trimEnd();class D{constructor(a,s){this.header=a,this.bodies=s}getBodyText(){return M(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class I{constructor(a,s,o){this.bodyCode=a,this.header=s,this.bodies=o}normalizedCommands(){const a={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[a]:[a,this.mergedBody()]}getBodyText(){return M(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const T=(e,a,s,o)=>{const n=e[a];if(!s(n))throw new Error(`Invalid head at index ${a}: ${JSON.stringify(n)}`);const t=[];for(let i=a+1;i<e.length;i++){const c=e[i];if(!o(c))break;t.push(c)}return{header:n,bodies:t}},P=(e,a)=>{const{bodies:s,header:o}=((n,t)=>T(n,t,i=>i.code===m.COMMENT_HEAD,i=>i.code===m.COMMENT_BODY))(e,a);return V(o)?new I(m.COMMENT_BODY,o,s):new D(o,s)},V=e=>e.parameters[0]==="選択肢ヘルプ",Y=(e,a)=>{const{bodies:s,header:o}=((n,t)=>T(n,t,i=>i.code===m.SHOW_MESSAGE,i=>i.code===m.SHOW_MESSAGE_BODY))(e,a);return new I(m.SHOW_MESSAGE_BODY,o,s)},U=(e,a)=>{const{bodies:s,header:o}=((n,t)=>T(n,t,i=>i.code===m.SCRIPT_EVAL,i=>i.code===m.SCRIPT_EVAL_BODY))(e,a);return new D(o,s)},q=(e,a)=>{const{bodies:s,header:o}=((n,t)=>T(n,t,i=>i.code===m.SHOW_SCROLLING_TEXT,i=>i.code===m.SHOW_SCROLLING_TEXT_BODY))(e,a);return new I(m.SHOW_SCROLLING_TEXT_BODY,o,s)},X={[m.SHOW_MESSAGE]:(e,a,s)=>s.showMessage(Y(e,a),a,e),[m.SCRIPT_EVAL]:(e,a,s)=>s.script(U(e,a),a,e),[m.COMMENT_HEAD]:(e,a,s)=>s.comment(P(e,a),a,e),[m.SHOW_SCROLLING_TEXT]:(e,a,s)=>s.showScrollingText(q(e,a),a,e)},x=e=>((a,s)=>({code:a.code,paramIndex:s,value:a.parameters[s]}))(e,1),j=e=>e.parameters[0].map((a,s)=>({code:102,paramIndex:s,value:a})),N=(e,a)=>H(e,a),H=(e,a)=>e.reduce((s,o,n)=>{if(o.code===m.SHOW_CHOICES)return[...s,...j(o)];const t=(i=o.code,X[i]);var i;if(t){const c=t(e,n,K);if(c!==void 0)return[...s,c]}if(o.code===m.CHANGE_NICKNAME)return[...s,x(o)];if(o.code===m.CHANGE_NAME)return[...s,x(o)];if(o.code===m.CHANGE_PROFILE)return[...s,x(o)];if(o.code===m.PLUGIN_COMMAND_MZ){const c=a(o);return c.length===0?s:[...s,...c]}return s},[]),K={comment:e=>{return a=e,{code:m.COMMENT_HEAD,paramIndex:0,value:a.getBodyText()};var a},showMessage:e=>{return a=e,{code:m.SHOW_MESSAGE_BODY,paramIndex:0,value:a.getBodyText(),speaker:(s=a.header,s.parameters[4]?s.parameters[4].trimEnd():"")};var a,s},script:e=>(a=>({code:m.SCRIPT_EVAL,paramIndex:0,value:a.getBodyText()}))(e),showScrollingText:e=>(a=>({code:m.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:a.getBodyText()}))(e)},z=(e,a)=>O(e,(s,o,n)=>({eventId:n.id,pageIndex:o,commands:N(s.list,a),note:n.note,noteItems:m.readNote(n.note),name:n.name})),y=(e,a,s)=>({folder:s,key:a,image:e[a],id:e.id}),d=(e,a)=>({note:G(e),main:a.map(s=>({key:s,text:e[s],id:e.id}))}),G=e=>m.readNoteEx(e.note,(a,s)=>({key:a,text:s,id:e.id}));exports.buildReferenceItemSources=(e,a,s,o,n,t)=>[...m.defineTraitItems(s,o),...m.defineGameDataSources(e,a),...m.defineSystemItems(n,t)],exports.compileItemEffectDisplayData=(e,a,s)=>{const o=m.resolveItemEffectLabels(a);return C.mergeItemsSource(s?[...o,...s]:o,e)},exports.compileTraitDisplayData=(e,a)=>C.mergeItemsSource(m.resolveTraitLabels(a),e),exports.extractBattleEventTexts=(e,a=()=>[])=>((s,o)=>s.map(n=>S(n,o)))(e,(s,o,{id:n})=>({eventId:n,pageIndex:o,commands:N(s.list,a)})),exports.extractCommonEventTexts=(e,a=()=>[])=>{return s=(o,n,{id:t})=>({eventId:t,commands:N(o.list,a)}),e.map(o=>s(o,0,o));var s},exports.extractImageFromActor=e=>[y(e,"faceName","faces"),y(e,"characterName","characters"),y(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractItemChangeData=_,exports.extractItemCommands=g,exports.extractItemFromMap=(e,a,s)=>O(e.map,(o,n,t)=>({...F(o),commands:g(o.list,a,s),eventName:t.name,pageIndex:n})),exports.extractItemFromTroop=(e,a,s)=>{return o=(n,t,i)=>({commands:g(n.list,a,s),eventName:i.name,troopId:i.id,pageIndex:t}),e.flatMap(n=>S(n,o));var o},exports.extractMapText=(e,a=()=>[])=>({note:e.note,noteItems:m.readNote(e.note),displayedName:e.displayName,events:z(e,a)}),exports.extractNoteText=G,exports.extractTextData=d,exports.extractTextFromActor=e=>d(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>d(e,["name","description"]),exports.extractTextFromClass=e=>d(e,["name"]),exports.extractTextFromEnemy=e=>d(e,["name"]),exports.extractTextFromEventCommands=e=>H(e,()=>[]),exports.extractTextFromItem=e=>d(e,["name","description"]),exports.extractTextFromSkill=e=>d(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>d(e,["name","message1","message2","message3","message4"]),exports.extractTextFromSystem=e=>({gameTitle:e.gameTitle,currencyUnit:e.currencyUnit,equipTypes:[...e.equipTypes],armorTypes:[...e.armorTypes],weaponTypes:[...e.weaponTypes],terms:{basic:m.makeTermsBasicFromArray(e.terms.basic),commands:m.makeTermsCommandFromArray(e.terms.commands),messages:m.makeTermsMessages(e.terms.messages),params:m.makeParamNamesFromArray(e.terms.params)}}),exports.extractTextFromWeapon=e=>d(e,["name","description"]),exports.replaceActorText=(e,a)=>{const s=p(e,a),o=r(e.name,a),n=r(e.nickname,a),t=r(e.profile,a);return{...e,name:o,nickname:n,profile:t,note:s}},exports.replaceArmorText=E,exports.replaceClassText=(e,a)=>{const s=p(e,a),o=r(e.name,a);return{...e,name:o,note:s}},exports.replaceCommonEventTexts=(e,a)=>({...e,list:u(e.list,a)}),exports.replaceEnemyText=(e,a)=>{const s=p(e,a),o=r(e.name,a);return{...e,name:o,note:s}},exports.replaceEventCommandTexts=u,exports.replaceItemText=E,exports.replaceMapDataTexts=(e,a)=>{const s=r(e.displayName,a),o=p(e,a),n={displayName:s,events:m.repleaceMapEventCommands(e,t=>u(t,a)),note:o};return{...e,...n}},exports.replaceNoteTextByMap=p,exports.replaceSkillText=(e,a)=>{const s=p(e,a),o=r(e.name,a),n=r(e.description,a),t=r(e.message1,a),i=r(e.message2,a);return{...e,name:o,description:n,message1:t,message2:i,note:s}},exports.replaceStateText=(e,a)=>{const s=p(e,a),o=r(e.name,a),n=r(e.message1,a),t=r(e.message2,a),i=r(e.message3,a),c=r(e.message4,a);return{...e,name:o,message1:n,message2:t,message3:i,message4:c,note:s}},exports.replaceSystemTerms=h,exports.replaceSystemText=(e,a)=>({...e,gameTitle:r(e.gameTitle,a),currencyUnit:r(e.currencyUnit,a),elements:l(e.elements,a),skillTypes:l(e.skillTypes,a),weaponTypes:l(e.weaponTypes,a),armorTypes:l(e.armorTypes,a),equipTypes:l(e.equipTypes,a),terms:h(e.terms,a)}),exports.replaceTextByMap=r,exports.replaceTextForCommand=A,exports.replaceTextForCommandActor=b,exports.replaceTextForCommandShowChoices=f,exports.replaceTextForCommandShowMessage=v,exports.replaceTroopTexts=(e,a)=>{const s=e.pages.map(o=>({list:u(o.list,a),conditions:o.conditions,span:o.span}));return{...e,pages:s}},exports.replaceWeaponText=E;
