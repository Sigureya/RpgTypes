"use strict";var pa=Object.defineProperty;var or=e=>{throw TypeError(e)};var da=(e,t,o)=>t in e?pa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var ir=(e,t,o)=>da(e,typeof t!="symbol"?t+"":t,o),fa=(e,t,o)=>t.has(e)||or("Cannot "+o);var cr=(e,t,o)=>t.has(e)?or("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,o);var ur=(e,t,o)=>(fa(e,t,"access private method"),o);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("../shared/make.cjs3.js"),lr=require("../shared/mergeItemsSource.cjs.js"),pe=require("../shared/lookupRpgDataKind.cjs.js"),Xe=(e,t,o)=>e.reduce((l,i)=>(i.code!==x.CHANGE_ARMORS&&i.code!==x.CHANGE_ITEMS&&i.code!==x.CHANGE_WEAPONS||l.push(Nr(i,t,o)),l),[]),ga={[x.CHANGE_WEAPONS]:"weapon",[x.CHANGE_ARMORS]:"armor",[x.CHANGE_ITEMS]:"item"},Nr=(e,t,o)=>{const l=e.parameters[3]===x.OPERAND_DIRECT?{direct:!0,value:e.parameters[2]}:{direct:!1,variableId:e.parameters[2]},i=e.parameters[0]===x.OPERATION_GAIN?t.gain:e.parameters[0]===x.OPERATION_LOSE?t.lose:t.unknown,d=typeof e.parameters[4]=="boolean"?{includesEquip:e.parameters[4]}:{};return{itemKind:ga[e.code],dataId:e.parameters[1],code:e.code,commandNameMZ:o(e.code),operation:i,...d,...l}},ha=e=>!!e,et=(e,t)=>e.pages.map((o,l)=>t(o,l,e)),Or=(e,t)=>e.events.filter(ha).flatMap(o=>et(o,t)),ya=e=>e.conditions.itemId>0&&e.conditions.itemValid?{pageCondition:{itemId:e.conditions.itemId}}:{},m=(e,t)=>{const o=e.trimEnd(),l=t.get(o);return l?l.trimEnd():o},ee=(e,t,o=`
`)=>x.replaceNote(e.note,l=>m(l.value,t),o),Ke=(e,t)=>{const o=ee(e,t),l=m(e.name,t),i=m(e.description,t);return{...e,name:l,description:i,note:o}},Ee=(e,t)=>e.map(o=>{switch(o.code){case x.SHOW_MESSAGE:return Ir(o,t);case x.SHOW_CHOICES:return wr(o,t);case x.SHOW_MESSAGE_BODY:case x.COMMENT_HEAD:case x.COMMENT_BODY:case x.SHOW_SCROLLING_TEXT_BODY:return Fr(o,t);case x.CHANGE_NAME:case x.CHANGE_NICKNAME:case x.CHANGE_PROFILE:return _r(o,t);default:return o}}),Fr=(e,t)=>{const o=m(e.parameters[0],t);return{code:e.code,indent:e.indent,parameters:[o]}},Ir=(e,t)=>{const o=e.parameters[4]?m(e.parameters[4],t):"";return x.makeCommandShowMessage({facename:e.parameters[0],faceIndex:e.parameters[1],background:e.parameters[2],positionType:e.parameters[3],speakerName:o},e.indent)},_r=(e,t)=>{const o=m(e.parameters[1],t);return{code:e.code,indent:e.indent,parameters:[e.parameters[0],o]}},wr=(e,t)=>{const o=e.parameters[0].map(l=>m(l,t));return{code:x.SHOW_CHOICES,indent:e.indent,parameters:[o,e.parameters[1],e.parameters[2],e.parameters[3],e.parameters[4]]}},mr=(e,t)=>({params:xa(e.params,t),messages:va(e.messages,t),commands:Aa(e.commands,t),basic:ba(e.basic,t)}),ba=(e,t)=>[m(e[0],t),m(e[1],t),m(e[2],t),m(e[3],t),m(e[4],t),m(e[5],t),m(e[6],t),m(e[7],t),m(e[8],t),m(e[9],t)],Aa=(e,t)=>[m(e[0],t),m(e[1],t),m(e[2],t),m(e[3],t),m(e[4],t),m(e[5],t),m(e[6],t),m(e[7],t),m(e[8],t),m(e[9],t),m(e[10],t),m(e[11],t),m(e[12],t),m(e[13],t),m(e[14],t),m(e[15],t),m(e[16],t),m(e[17],t),m(e[18],t),m(e[19],t),"",m(e[21],t),m(e[22],t),"",m(e[24],t),m(e[25],t)],xa=(e,t)=>[m(e[0],t),m(e[1],t),m(e[2],t),m(e[3],t),m(e[4],t),m(e[5],t),m(e[6],t),m(e[7],t),m(e[8],t),m(e[9],t)],va=(e,t)=>({actionFailure:m(e.actionFailure,t),actorDamage:m(e.actorDamage,t),actorDrain:m(e.actorDrain,t),actorGain:m(e.actorGain,t),actorLoss:m(e.actorLoss,t),actorNoDamage:m(e.actorNoDamage,t),actorNoHit:m(e.actorNoHit,t),actorRecovery:m(e.actorRecovery,t),alwaysDash:m(e.alwaysDash,t),autosave:m(e.autosave,t),bgmVolume:m(e.bgmVolume,t),bgsVolume:m(e.bgsVolume,t),buffAdd:m(e.buffAdd,t),buffRemove:m(e.buffRemove,t),commandRemember:m(e.commandRemember,t),counterAttack:m(e.counterAttack,t),criticalToActor:m(e.criticalToActor,t),criticalToEnemy:m(e.criticalToEnemy,t),defeat:m(e.defeat,t),debuffAdd:m(e.debuffAdd,t),emerge:m(e.emerge,t),enemyDamage:m(e.enemyDamage,t),enemyDrain:m(e.enemyDrain,t),enemyGain:m(e.enemyGain,t),enemyLoss:m(e.enemyLoss,t),enemyNoDamage:m(e.enemyNoDamage,t),enemyNoHit:m(e.enemyNoHit,t),enemyRecovery:m(e.enemyRecovery,t),escapeFailure:m(e.escapeFailure,t),escapeStart:m(e.escapeStart,t),evasion:m(e.evasion,t),expNext:m(e.expNext,t),expTotal:m(e.expTotal,t),file:m(e.file,t),loadMessage:m(e.loadMessage,t),levelUp:m(e.levelUp,t),magicEvasion:m(e.magicEvasion,t),magicReflection:m(e.magicReflection,t),meVolume:m(e.meVolume,t),obtainExp:m(e.obtainExp,t),obtainGold:m(e.obtainGold,t),obtainItem:m(e.obtainItem,t),obtainSkill:m(e.obtainSkill,t),partyName:m(e.partyName,t),possession:m(e.possession,t),preemptive:m(e.preemptive,t),saveMessage:m(e.saveMessage,t),seVolume:m(e.seVolume,t),substitute:m(e.substitute,t),surprise:m(e.surprise,t),touchUI:m(e.touchUI,t),useItem:m(e.useItem,t),victory:m(e.victory,t)}),le=(e,t)=>e.map(o=>m(o,t)),kr=e=>e.map(t=>t.parameters[0].trimEnd()).join(`
`).trimEnd();class Mr{constructor(t,o){this.header=t,this.bodies=o}getBodyText(){return kr(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class at{constructor(t,o,l){this.bodyCode=t,this.header=o,this.bodies=l}normalizedCommands(){const t={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[t]:[t,this.mergedBody()]}getBodyText(){return kr(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const Ie=(e,t,o,l)=>{const i=e[t];if(!o(i))throw new Error(`Invalid head at index ${t}: ${JSON.stringify(i)}`);const d=[];for(let g=t+1;g<e.length;g++){const r=e[g];if(!l(r))break;d.push(r)}return{header:i,bodies:d}},Ca=(e,t)=>{const{bodies:o,header:l}=((i,d)=>Ie(i,d,g=>g.code===x.COMMENT_HEAD,g=>g.code===x.COMMENT_BODY))(e,t);return Ea(l)?new at(x.COMMENT_BODY,l,o):new Mr(l,o)},Ea=e=>e.parameters[0]==="選択肢ヘルプ",Sa=(e,t)=>{const{bodies:o,header:l}=((i,d)=>Ie(i,d,g=>g.code===x.SHOW_MESSAGE,g=>g.code===x.SHOW_MESSAGE_BODY))(e,t);return new at(x.SHOW_MESSAGE_BODY,l,o)},Ta=(e,t)=>{const{bodies:o,header:l}=((i,d)=>Ie(i,d,g=>g.code===x.SCRIPT_EVAL,g=>g.code===x.SCRIPT_EVAL_BODY))(e,t);return new Mr(l,o)},Na=(e,t)=>{const{bodies:o,header:l}=((i,d)=>Ie(i,d,g=>g.code===x.SHOW_SCROLLING_TEXT,g=>g.code===x.SHOW_SCROLLING_TEXT_BODY))(e,t);return new at(x.SHOW_SCROLLING_TEXT_BODY,l,o)},Oa={[x.SHOW_MESSAGE]:(e,t,o)=>o.showMessage(Sa(e,t),t,e),[x.SCRIPT_EVAL]:(e,t,o)=>o.script(Ta(e,t),t,e),[x.COMMENT_HEAD]:(e,t,o)=>o.comment(Ca(e,t),t,e),[x.SHOW_SCROLLING_TEXT]:(e,t,o)=>o.showScrollingText(Na(e,t),t,e)},Ze=e=>((t,o)=>({code:t.code,paramIndex:o,value:t.parameters[o]}))(e,1),Fa=e=>e.parameters[0].map((t,o)=>({code:102,paramIndex:o,value:t})),tt=(e,t)=>Pr(e,t),Pr=(e,t)=>e.reduce((o,l,i)=>{if(l.code===x.SHOW_CHOICES)return[...o,...Fa(l)];const d=(g=l.code,Oa[g]);var g;if(d){const r=d(e,i,Ia);if(r!==void 0)return[...o,r]}if(l.code===x.CHANGE_NICKNAME)return[...o,Ze(l)];if(l.code===x.CHANGE_NAME)return[...o,Ze(l)];if(l.code===x.CHANGE_PROFILE)return[...o,Ze(l)];if(l.code===x.PLUGIN_COMMAND_MZ){const r=t(l);return r.length===0?o:[...o,...r]}return o},[]),Ia={comment:e=>{return t=e,{code:x.COMMENT_HEAD,paramIndex:0,value:t.getBodyText()};var t},showMessage:e=>{return t=e,{code:x.SHOW_MESSAGE_BODY,paramIndex:0,value:t.getBodyText(),speaker:(o=t.header,o.parameters[4]?o.parameters[4].trimEnd():"")};var t,o},script:e=>(t=>({code:x.SCRIPT_EVAL,paramIndex:0,value:t.getBodyText()}))(e),showScrollingText:e=>(t=>({code:x.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:t.getBodyText()}))(e)},_a=(e,t)=>Or(e,(o,l,i)=>({eventId:i.id,pageIndex:l,commands:tt(o.list,t),note:i.note,noteItems:x.readNote(i.note),name:i.name})),Qe=(e,t,o)=>({folder:o,key:t,image:e[t],id:e.id}),K=(e,t)=>({note:Lr(e),main:t.map(o=>({key:o,text:e[o],id:e.id}))}),Lr=e=>x.readNoteEx(e.note,(t,o)=>({key:t,text:o,id:e.id})),wa=(e,t)=>`${t}[${e.map(o=>`"${o.name}"`).join(",")}]`,pr={undefinedStruct:"undefined_struct",cyclicStruct:"cyclic_struct"},ka=(e,t,o,l)=>{if(o.scalas.length>0||o.scalaArrays.length>0){const i=((d,{path:g,structName:r})=>{return{arraySchema:pe.toObjectPluginParams(d.scalaArrays),objectSchema:pe.toObjectPluginParams(d.scalas),structName:r,scalaArrays:(v=d.scalaArrays,M=g,v.map(D=>({path:`${M}.${D.name}[*]`,param:D}))),scalas:d.scalas.length>0?wa(d.scalas,g):void 0};var v,M})(o,{path:t.basePath,structName:t.schemaName});return{frames:[...e.frames,...l],items:[...e.items,i],errs:e.errs}}return l.length>0?{frames:[...e.frames,...l],items:e.items,errs:e.errs}:e};function dr(e,t,o,l){const i={items:[],errs:[],frames:[{schemaName:e,basePath:t,ancestry:[]}]},d=Math.max(1,3*o.size+5),g=Array.from({length:d}).reduce(r=>r.frames.length===0?r:((v,M,D)=>{if(v.frames.length===0)return v;const k=v.frames.pop();if(k.ancestry.includes(k.schemaName))return{frames:v.frames,items:v.items,errs:[...v.errs,{code:D.cyclicStruct,path:k.basePath}]};const j=M.get(k.schemaName);if(!j)return{frames:v.frames,items:v.items,errs:[...v.errs,{code:D.undefinedStruct,path:k.basePath}]};const W=((_,F)=>{const V=_.ancestry.concat(_.schemaName),z=_.basePath;return[...F.structs.map(ne=>({schemaName:ne.attr.struct,basePath:`${z}.${ne.name}`,ancestry:V})),...F.structArrays.map(ne=>({schemaName:ne.attr.struct,basePath:`${z}.${ne.name}[*]`,ancestry:V}))].reverse()})(k,j);return ka(v,k,j,W)})(r,o,l),i);return{items:g.items,errors:g.errs}}var fr,Se,Ma=Object.create,gr=Object.defineProperty,Pa=Object.getOwnPropertyDescriptor,La=Object.getOwnPropertyNames,$a=Object.getPrototypeOf,Da=Object.prototype.hasOwnProperty,ja=(fr=(e,t)=>{function o(i,d){return d.reduce(function(g,r){return{type:"LogicalBinary",operator:r[1],left:g,right:r[3]}},i)}var l=class extends SyntaxError{constructor(i,d,g,r){super(i),this.expected=d,this.found=g,this.location=r,this.name="SyntaxError"}format(i){let d="Error: "+this.message;if(this.location){let g=null,r=i.find(k=>k.source===this.location.source);r&&(g=r.text.split(/\r\n|\n|\r/g));let v=this.location.start,M=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(v):v,D=this.location.source+":"+M.line+":"+M.column;if(g){let k=this.location.end,j="".padEnd(M.line.toString().length," "),W=g[v.line-1],_=(v.line===k.line?k.column:W.length+1)-v.column||1;d+=`
 --> `+D+`
`+j+` |
`+M.line+" | "+W+`
`+j+" | "+"".padEnd(v.column-1," ")+"".padEnd(_,"^")}else d+=`
 at `+D}return d}static buildMessage(i,d){function g(_){return _.codePointAt(0).toString(16).toUpperCase()}let r=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?new RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function v(_){return r?_.replace(r,F=>"\\u{"+g(F)+"}"):_}function M(_){return v(_.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,F=>"\\x0"+g(F)).replace(/[\x10-\x1F\x7F-\x9F]/g,F=>"\\x"+g(F)))}function D(_){return v(_.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,F=>"\\x0"+g(F)).replace(/[\x10-\x1F\x7F-\x9F]/g,F=>"\\x"+g(F)))}let k={literal:_=>'"'+M(_.text)+'"',class(_){let F=_.parts.map(V=>Array.isArray(V)?D(V[0])+"-"+D(V[1]):D(V));return"["+(_.inverted?"^":"")+F.join("")+"]"+(_.unicode?"u":"")},any:()=>"any character",end:()=>"end of input",other:_=>_.description};function j(_){return k[_.type](_)}return"Expected "+function(_){let F=_.map(j);if(F.sort(),F.length>0){let V=1;for(let z=1;z<F.length;z++)F[z-1]!==F[z]&&(F[V]=F[z],V++);F.length=V}switch(F.length){case 1:return F[0];case 2:return F[0]+" or "+F[1];default:return F.slice(0,-1).join(", ")+", or "+F[F.length-1]}}(i)+" but "+((W=d)?'"'+M(W)+'"':"end of input")+" found.";var W}};t.exports={StartRules:["JsonpathQuery"],SyntaxError:l,parse:function(i,d){let g,r={},v=(d=d!==void 0?d:{}).grammarSource,M={JsonpathQuery:Be},D=Be,k="$",j='"',W="'",_="\\",F="b",V="f",z="n",ne="r",rn="t",nn="/",mt="u",we="d",an="*",sn="0",on="-",pt=":",cn="?",fe="||",ge="&&",dt="(",ft=")",un="!",ln="@",gt="==",ht="!=",yt="<=",bt=">=",ke="[",Me="]",Pe=".",At="-0",mn="e",xt="true",vt="false",Ct="null",he=",",Et="..",pn=/^[\t-\n\r ]/,dn=/^[ -!#-&(-[\]-\uD7FF\uE000-\uFFFF]/,St=/^[\uD800-\uDBFF]/,Tt=/^[\uDC00-\uDFFF]/,fn=/^[ABCEF]/i,gn=/^[0-7]/,hn=/^[89AB]/i,yn=/^[CDEF]/i,bn=/^[ABCDEF]/i,An=/^[1-9]/,xn=/^[<>]/,vn=/^[\-+]/,Cn=/^[0-9_a-z]/,En=/^[a-z]/,Sn=/^[_\x80-\uD7FF\uE000-\uFFFF]/,Tn=/^[0-9]/,Nn=/^[a-z]/i,On=H([["	",`
`],"\r"," "],!1,!1,!1),Fn=T("$",!1),ye=T('"',!1),be=T("'",!1),Le=T("\\",!1),In=H([[" ","!"],["#","&"],["(","["],["]","퟿"],["","￿"]],!1,!1,!1),Nt=H([["\uD800","\uDBFF"]],!1,!1,!1),Ot=H([["\uDC00","\uDFFF"]],!1,!1,!1),_n=T("b",!1),wn=T("f",!1),kn=T("n",!1),Mn=T("r",!1),Pn=T("t",!1),Ln=T("/",!1),Ft=T("u",!1),$n=H(["A","B","C","E","F"],!1,!0,!1),$e=T("D",!0),Dn=H([["0","7"]],!1,!1,!1),jn=H(["8","9","A","B"],!1,!0,!1),Rn=H(["C","D","E","F"],!1,!0,!1),Bn=H(["A","B","C","D","E","F"],!1,!0,!1),Hn=T("*",!1),Gn=T("0",!1),qn=T("-",!1),Wn=H([["1","9"]],!1,!1,!1),It=T(":",!1),Vn=T("?",!1),_t=T("||",!1),wt=T("&&",!1),kt=T("(",!1),Mt=T(")",!1),Un=T("!",!1),Yn=T("@",!1),zn=T("==",!1),Jn=T("!=",!1),Xn=T("<=",!1),Kn=T(">=",!1),Zn=H(["<",">"],!1,!1,!1),De=T("[",!1),je=T("]",!1),Re=T(".",!1),Qn=T("-0",!1),ea=T("e",!0),ta=H(["-","+"],!1,!1,!1),ra=T("true",!1),na=T("false",!1),aa=T("null",!1),sa=H([["0","9"],"_",["a","z"]],!1,!1,!1),oa=H([["a","z"]],!1,!1,!1),Ae=T(",",!1),ia=H(["_",["","퟿"],["","￿"]],!1,!1,!1),ca=H([["0","9"]],!1,!1,!1),ua=H([["a","z"]],!1,!0,!1),la=T("..",!1),n=0|d.peg$currPos,E=n,se=[{line:1,column:1}],Y=n,xe=d.peg$maxFailExpected||[],y=0|d.peg$silentFails;if(d.startRule){if(!(d.startRule in M))throw new Error(`Can't start parsing from rule "`+d.startRule+'".');D=M[d.startRule]}function oe(){return i.substring(E,n)}function T(a,s){return{type:"literal",text:a,ignoreCase:s}}function H(a,s,c,u){return{type:"class",parts:a,inverted:s,ignoreCase:c,unicode:u}}function Pt(a){let s,c=se[a];if(c)return c;if(a>=se.length)s=se.length-1;else for(s=a;!se[--s];);for(c=se[s],c={line:c.line,column:c.column};s<a;)i.charCodeAt(s)===10?(c.line++,c.column=1):c.column++,s++;return se[a]=c,c}function Lt(a,s,c){let u=Pt(a),p=Pt(s);return{source:v,start:{offset:a,line:u.line,column:u.column},end:{offset:s,line:p.line,column:p.column}}}function h(a){n<Y||(n>Y&&(Y=n,xe=[]),xe.push(a))}function Be(){let a,s,c;return a=n,s=jt(),s!==r?(c=$t(),E=a,a=function(u){return{type:"Root",segments:u}}(c)):(n=a,a=r),a}function $t(){let a,s,c;for(a=[],s=n,I(),c=tr(),c!==r?s=c:(n=s,s=r);s!==r;)a.push(s),s=n,I(),c=tr(),c!==r?s=c:(n=s,s=r);return a}function I(){let a,s;for(a=[],s=Dt();s!==r;)a.push(s),s=Dt();return a}function Dt(){let a;return a=i.charAt(n),pn.test(a)?n++:(a=r,y===0&&h(On)),a}function jt(){let a;return i.charCodeAt(n)===36?(a=k,n++):(a=r,y===0&&h(Fn)),a}function He(){let a;return a=Rt(),a===r&&(a=Ge(),a===r&&(a=function(){let s,c,u,p,f,b,A,N;return s=n,c=n,u=ue(),u!==r?(I(),c=u):(n=c,c=r),c===r&&(c=null),i.charCodeAt(n)===58?(u=pt,n++):(u=r,y===0&&h(It)),u!==r?(I(),p=n,f=ue(),f!==r?(b=I(),p=f):(n=p,p=r),p===r&&(p=null),f=n,i.charCodeAt(n)===58?(b=pt,n++):(b=r,y===0&&h(It)),b!==r?(A=n,I(),N=ue(),N!==r?A=N:(n=A,A=r),A===r&&(A=null),f=A):(n=f,f=r),f===r&&(f=null),E=s,s=function(P,C,O){return{type:"SliceSelector",start:P,end:C,step:O}}(c,p,f)):(n=s,s=r),s}(),a===r&&(a=Vt(),a===r&&(a=function(){let s,c,u;return s=n,i.charCodeAt(n)===63?(c=cn,n++):(c=r,y===0&&h(Vn)),c!==r?(I(),u=qe(),u!==r?(E=s,s=function(p){return{type:"FilterSelector",expr:p}}(u)):(n=s,s=r)):(n=s,s=r),s}())))),a}function Rt(){let a,s;return a=n,s=Bt(),s!==r&&(E=a,s=function(c){return{type:"NameSelector",member:c}}(s)),a=s,a}function Bt(){let a,s,c,u;if(a=n,i.charCodeAt(n)===34?(s=j,n++):(s=r,y===0&&h(ye)),s!==r){for(c=[],u=Ht();u!==r;)c.push(u),u=Ht();i.charCodeAt(n)===34?(u=j,n++):(u=r,y===0&&h(ye)),u!==r?(E=a,a=function(p){return p.join("")}(c)):(n=a,a=r)}else n=a,a=r;if(a===r)if(a=n,i.charCodeAt(n)===39?(s=W,n++):(s=r,y===0&&h(be)),s!==r){for(c=[],u=Gt();u!==r;)c.push(u),u=Gt();i.charCodeAt(n)===39?(u=W,n++):(u=r,y===0&&h(be)),u!==r?(E=a,a=function(p){return p.join("")}(c)):(n=a,a=r)}else n=a,a=r;return a}function Ht(){let a,s,c;return a=qt(),a===r&&(i.charCodeAt(n)===39?(a=W,n++):(a=r,y===0&&h(be)),a===r&&(a=n,s=ve(),s!==r?(i.charCodeAt(n)===34?(c=j,n++):(c=r,y===0&&h(ye)),c!==r?a=c:(n=a,a=r)):(n=a,a=r),a===r&&(a=n,s=ve(),s!==r?(c=Wt(),c!==r?a=c:(n=a,a=r)):(n=a,a=r)))),a}function Gt(){let a,s,c;return a=qt(),a===r&&(i.charCodeAt(n)===34?(a=j,n++):(a=r,y===0&&h(ye)),a===r&&(a=n,s=ve(),s!==r?(i.charCodeAt(n)===39?(c=W,n++):(c=r,y===0&&h(be)),c!==r?a=c:(n=a,a=r)):(n=a,a=r),a===r&&(a=n,s=ve(),s!==r?(c=Wt(),c!==r?a=c:(n=a,a=r)):(n=a,a=r)))),a}function ve(){let a;return i.charCodeAt(n)===92?(a=_,n++):(a=r,y===0&&h(Le)),a}function qt(){let a,s,c,u;return a=i.charAt(n),dn.test(a)?n++:(a=r,y===0&&h(In)),a===r&&(a=n,s=n,c=i.charAt(n),St.test(c)?n++:(c=r,y===0&&h(Nt)),c!==r?(u=i.charAt(n),Tt.test(u)?n++:(u=r,y===0&&h(Ot)),u!==r?(c=[c,u],s=c):(n=s,s=r)):(n=s,s=r),a=s!==r?i.substring(a,n):s),a}function Wt(){let a,s,c,u;return a=n,i.charCodeAt(n)===98?(s=F,n++):(s=r,y===0&&h(_n)),s!==r&&(E=a,s="\b"),a=s,a===r&&(a=n,i.charCodeAt(n)===102?(s=V,n++):(s=r,y===0&&h(wn)),s!==r&&(E=a,s="\f"),a=s,a===r&&(a=n,i.charCodeAt(n)===110?(s=z,n++):(s=r,y===0&&h(kn)),s!==r&&(E=a,s=`
`),a=s,a===r&&(a=n,i.charCodeAt(n)===114?(s=ne,n++):(s=r,y===0&&h(Mn)),s!==r&&(E=a,s="\r"),a=s,a===r&&(a=n,i.charCodeAt(n)===116?(s=rn,n++):(s=r,y===0&&h(Pn)),s!==r&&(E=a,s="	"),a=s,a===r&&(a=n,i.charCodeAt(n)===47?(s=nn,n++):(s=r,y===0&&h(Ln)),s!==r&&(E=a,s="/"),a=s,a===r&&(a=n,i.charCodeAt(n)===92?(s=_,n++):(s=r,y===0&&h(Le)),s!==r&&(E=a,s="\\"),a=s,a===r&&(a=n,s=n,i.charCodeAt(n)===117?(c=mt,n++):(c=r,y===0&&h(Ft)),c!==r?(u=function(){let p,f,b,A,N,P;return p=n,f=function(){let C,O,w,L,$,R,Ce;if(C=n,O=n,w=X(),w===r&&(w=i.charAt(n),fn.test(w)?n++:(w=r,y===0&&h($n))),w!==r){for(L=n,$=[],R=Q();R!==r;)$.push(R),R=$.length>=3?r:Q();$.length<3?(n=L,L=r):L=$,L!==r?(w=[w,L],O=w):(n=O,O=r)}else n=O,O=r;if(O!==r&&(E=C,O=parseInt(oe(),16)),C=O,C===r){if(C=n,O=n,w=i.charAt(n),w.toLowerCase()===we?n++:(w=r,y===0&&h($e)),w!==r)if(L=i.charAt(n),gn.test(L)?n++:(L=r,y===0&&h(Dn)),L!==r){for($=n,R=[],Ce=Q();Ce!==r;)R.push(Ce),Ce=R.length>=2?r:Q();R.length<2?(n=$,$=r):$=R,$!==r?(w=[w,L,$],O=w):(n=O,O=r)}else n=O,O=r;else n=O,O=r;O!==r&&(E=C,O=parseInt(oe(),16)),C=O}return C}(),f!==r&&(E=p,f=function(C){return[C]}(f)),p=f,p===r&&(p=n,f=n,b=function(){let C,O,w,L,$,R;if(C=n,O=i.charAt(n),O.toLowerCase()===we?n++:(O=r,y===0&&h($e)),O!==r)if(w=i.charAt(n),hn.test(w)?n++:(w=r,y===0&&h(jn)),w!==r){for(L=n,$=[],R=Q();R!==r;)$.push(R),R=$.length>=2?r:Q();$.length<2?(n=L,L=r):L=$,L!==r?(E=C,C=parseInt(oe(),16)):(n=C,C=r)}else n=C,C=r;else n=C,C=r;return C}(),b!==r?(i.charCodeAt(n)===92?(A=_,n++):(A=r,y===0&&h(Le)),A!==r?(i.charCodeAt(n)===117?(N=mt,n++):(N=r,y===0&&h(Ft)),N!==r?(P=function(){let C,O,w,L,$,R;if(C=n,O=i.charAt(n),O.toLowerCase()===we?n++:(O=r,y===0&&h($e)),O!==r)if(w=i.charAt(n),yn.test(w)?n++:(w=r,y===0&&h(Rn)),w!==r){for(L=n,$=[],R=Q();R!==r;)$.push(R),R=$.length>=2?r:Q();$.length<2?(n=L,L=r):L=$,L!==r?(E=C,C=parseInt(oe(),16)):(n=C,C=r)}else n=C,C=r;else n=C,C=r;return C}(),P!==r?f=[b,P]:(n=f,f=r)):(n=f,f=r)):(n=f,f=r)):(n=f,f=r),f!==r&&(E=p),p=f),p}(),u!==r?s=u:(n=s,s=r)):(n=s,s=r),s!==r&&(E=a,s=function(p){return String.fromCharCode(...p)}(s)),a=s))))))),a}function Q(){let a;return a=X(),a===r&&(a=i.charAt(n),bn.test(a)?n++:(a=r,y===0&&h(Bn))),a}function Ge(){let a,s;return a=n,i.charCodeAt(n)===42?(s=an,n++):(s=r,y===0&&h(Hn)),s!==r&&(E=a,s={type:"WildcardSelector"}),a=s,a}function Vt(){let a,s;return a=n,s=ue(),s!==r&&(E=a,s=function(c){return{type:"IndexSelector",index:c}}(s)),a=s,a}function ue(){let a,s,c,u,p,f;if(a=n,i.charCodeAt(n)===48?(s=sn,n++):(s=r,y===0&&h(Gn)),s!==r&&(E=a,s=0),a=s,a===r){if(a=n,s=n,i.charCodeAt(n)===45?(c=on,n++):(c=r,y===0&&h(qn)),c===r&&(c=null),u=function(){let b;return b=i.charAt(n),An.test(b)?n++:(b=r,y===0&&h(Wn)),b}(),u!==r){for(p=[],f=X();f!==r;)p.push(f),f=X();c=[c,u,p],s=c}else n=s,s=r;s!==r&&(E=a,s=function(){let b=parseInt(oe());if(Number.MIN_SAFE_INTEGER<=b&&b<=Number.MAX_SAFE_INTEGER)return b;throw new Error(`Index must be within the range of I-JSON: ${b}`)}()),a=s}return a}function qe(){let a,s,c,u,p,f,b,A;if(a=n,s=We(),s!==r){for(c=[],u=n,p=I(),i.substr(n,2)===fe?(f=fe,n+=2):(f=r,y===0&&h(_t)),f!==r?(b=I(),A=We(),A!==r?(p=[p,f,b,A],u=p):(n=u,u=r)):(n=u,u=r);u!==r;)c.push(u),u=n,p=I(),i.substr(n,2)===fe?(f=fe,n+=2):(f=r,y===0&&h(_t)),f!==r?(b=I(),A=We(),A!==r?(p=[p,f,b,A],u=p):(n=u,u=r)):(n=u,u=r);E=a,a=function(N,P){return o(N,P)}(s,c)}else n=a,a=r;return a}function We(){let a,s,c,u,p,f,b,A;if(a=n,s=Ve(),s!==r){for(c=[],u=n,p=I(),i.substr(n,2)===ge?(f=ge,n+=2):(f=r,y===0&&h(wt)),f!==r?(b=I(),A=Ve(),A!==r?(p=[p,f,b,A],u=p):(n=u,u=r)):(n=u,u=r);u!==r;)c.push(u),u=n,p=I(),i.substr(n,2)===ge?(f=ge,n+=2):(f=r,y===0&&h(wt)),f!==r?(b=I(),A=Ve(),A!==r?(p=[p,f,b,A],u=p):(n=u,u=r)):(n=u,u=r);E=a,a=function(N,P){return o(N,P)}(s,c)}else n=a,a=r;return a}function Ve(){let a;return a=function(){let s,c,u,p,f;return s=n,c=n,u=Ut(),u!==r?(I(),c=u):(n=c,c=r),c===r&&(c=null),i.charCodeAt(n)===40?(u=dt,n++):(u=r,y===0&&h(kt)),u!==r?(I(),p=qe(),p!==r?(I(),i.charCodeAt(n)===41?(f=ft,n++):(f=r,y===0&&h(Mt)),f!==r?(E=s,s=function(b,A){return b?{type:"LogicalUnary",operator:"!",expr:A}:A}(c,p)):(n=s,s=r)):(n=s,s=r)):(n=s,s=r),s}(),a===r&&(a=function(){let s,c,u,p;return s=n,c=Xt(),c!==r?(I(),u=function(){let f;return i.substr(n,2)===gt?(f=gt,n+=2):(f=r,y===0&&h(zn)),f===r&&(i.substr(n,2)===ht?(f=ht,n+=2):(f=r,y===0&&h(Jn)),f===r&&(i.substr(n,2)===yt?(f=yt,n+=2):(f=r,y===0&&h(Xn)),f===r&&(i.substr(n,2)===bt?(f=bt,n+=2):(f=r,y===0&&h(Kn)),f===r&&(f=i.charAt(n),xn.test(f)?n++:(f=r,y===0&&h(Zn)))))),f}(),u!==r?(I(),p=Xt(),p!==r?(E=s,s=function(f,b,A){return{type:"ComparisonExpr",left:f,operator:b,right:A}}(c,u,p)):(n=s,s=r)):(n=s,s=r)):(n=s,s=r),s}(),a===r&&(a=function(){let s,c,u;return s=n,c=n,u=Ut(),u!==r?(I(),c=u):(n=c,c=r),c===r&&(c=null),u=Yt(),u===r&&(u=Ue()),u!==r?(E=s,s=function(p,f){return function(b,A){return b?{type:"LogicalUnary",operator:"!",expr:A}:A}(p,{type:"TestExpr",query:f})}(c,u)):(n=s,s=r),s}())),a}function Ut(){let a;return i.charCodeAt(n)===33?(a=un,n++):(a=r,y===0&&h(Un)),a}function Yt(){let a;return a=function(){let s,c,u;return s=n,c=zt(),c!==r?(u=$t(),u!==r?(E=s,s=function(p){return{type:"CurrentNode",segments:p}}(u)):(n=s,s=r)):(n=s,s=r),s}(),a===r&&(a=Be()),a}function zt(){let a;return i.charCodeAt(n)===64?(a=ln,n++):(a=r,y===0&&h(Yn)),a}function Jt(){let a,s;return a=n,s=function(){let c,u,p,f;return c=n,u=ue(),u===r&&(i.substr(n,2)===At?(u=At,n+=2):(u=r,y===0&&h(Qn))),u!==r?(p=function(){let b,A,N,P,C;if(b=n,A=n,i.charCodeAt(n)===46?(N=Pe,n++):(N=r,y===0&&h(Re)),N!==r){if(P=[],C=X(),C!==r)for(;C!==r;)P.push(C),C=X();else P=r;P!==r?(N=[N,P],A=N):(n=A,A=r)}else n=A,A=r;return b=A!==r?i.substring(b,n):A,b}(),p===r&&(p=null),f=function(){let b,A,N,P,C;if(b=n,A=i.charAt(n),A.toLowerCase()===mn?n++:(A=r,y===0&&h(ea)),A!==r){if(N=i.charAt(n),vn.test(N)?n++:(N=r,y===0&&h(ta)),N===r&&(N=null),P=[],C=X(),C!==r)for(;C!==r;)P.push(C),C=X();else P=r;P!==r?(E=b,b=function(O,w){return parseInt(`${O||""}${w.join("")}`)}(N,P)):(n=b,b=r)}else n=b,b=r;return b}(),f===r&&(f=null),E=c,c=function(b,A,N){return parseFloat(`${b}${A??""}${N?`e${N}`:""}`)}(u,p,f)):(n=c,c=r),c}(),s===r&&(s=Bt(),s===r&&(s=function(){let c,u;return c=n,i.substr(n,4)===xt?(u=xt,n+=4):(u=r,y===0&&h(ra)),u!==r&&(E=c,u=!0),c=u,c}(),s===r&&(s=function(){let c,u;return c=n,i.substr(n,5)===vt?(u=vt,n+=5):(u=r,y===0&&h(na)),u!==r&&(E=c,u=!1),c=u,c}(),s===r&&(s=function(){let c,u;return c=n,i.substr(n,4)===Ct?(u=Ct,n+=4):(u=r,y===0&&h(aa)),u!==r&&(E=c,u=null),c=u,c}())))),s!==r&&(E=a,s=function(c){return{type:"Literal",member:c}}(s)),a=s,a}function Xt(){let a;return a=Jt(),a===r&&(a=function(){let s;return s=function(){let c,u,p;return c=n,u=zt(),u!==r?(p=Kt(),E=c,c=function(f){return{type:"CurrentNode",segments:f}}(p)):(n=c,c=r),c}(),s===r&&(s=function(){let c,u,p;return c=n,u=jt(),u!==r?(p=Kt(),E=c,c=function(f){return{type:"Root",segments:f}}(p)):(n=c,c=r),c}()),s}(),a===r&&(a=Ue())),a}function Kt(){let a,s,c,u;for(a=n,s=[],c=n,I(),u=Zt(),u===r&&(u=Qt()),u!==r?c=u:(n=c,c=r);c!==r;)s.push(c),c=n,I(),u=Zt(),u===r&&(u=Qt()),u!==r?c=u:(n=c,c=r);return E=a,a=s,a}function Zt(){let a,s,c,u;return a=n,i.charCodeAt(n)===91?(s=ke,n++):(s=r,y===0&&h(De)),s!==r?(c=Rt(),c!==r?(i.charCodeAt(n)===93?(u=Me,n++):(u=r,y===0&&h(je)),u!==r?(E=a,a=function(p){return[p]}(c)):(n=a,a=r)):(n=a,a=r)):(n=a,a=r),a===r&&(a=n,i.charCodeAt(n)===46?(s=Pe,n++):(s=r,y===0&&h(Re)),s!==r?(c=ze(),c!==r?(E=a,a=function(p){return[p]}(c)):(n=a,a=r)):(n=a,a=r)),a}function Qt(){let a,s,c,u;return a=n,i.charCodeAt(n)===91?(s=ke,n++):(s=r,y===0&&h(De)),s!==r?(c=Vt(),c!==r?(i.charCodeAt(n)===93?(u=Me,n++):(u=r,y===0&&h(je)),u!==r?(E=a,a=function(p){return[p]}(c)):(n=a,a=r)):(n=a,a=r)):(n=a,a=r),a}function ma(){let a,s,c,u,p;if(a=n,s=n,c=function(){let f;return f=i.charAt(n),En.test(f)?n++:(f=r,y===0&&h(oa)),f}(),c!==r){for(u=[],p=er();p!==r;)u.push(p),p=er();c=[c,u],s=c}else n=s,s=r;return a=s!==r?i.substring(a,n):s,a}function er(){let a;return a=i.charAt(n),Cn.test(a)?n++:(a=r,y===0&&h(sa)),a}function Ue(){let a,s,c,u,p,f,b,A,N;if(a=n,s=ma(),s!==r)if(i.charCodeAt(n)===40?(c=dt,n++):(c=r,y===0&&h(kt)),c!==r){if(I(),u=n,p=Ye(),p!==r){for(f=[],b=n,I(),i.charCodeAt(n)===44?(A=he,n++):(A=r,y===0&&h(Ae)),A!==r?(I(),N=Ye(),N!==r?b=N:(n=b,b=r)):(n=b,b=r);b!==r;)f.push(b),b=n,I(),i.charCodeAt(n)===44?(A=he,n++):(A=r,y===0&&h(Ae)),A!==r?(I(),N=Ye(),N!==r?b=N:(n=b,b=r)):(n=b,b=r);u=[p,f]}else n=u,u=r;u===r&&(u=null),p=I(),i.charCodeAt(n)===41?(f=ft,n++):(f=r,y===0&&h(Mt)),f!==r?(E=a,a=function(P,C){let O=C[0],w=C[1];return{type:"FunctionExpr",name:P,args:[O].concat(w)}}(s,u)):(n=a,a=r)}else n=a,a=r;else n=a,a=r;return a}function Ye(){let a;return a=Jt(),a===r&&(a=Yt(),a===r&&(a=Ue(),a===r&&(a=qe()))),a}function tr(){let a;return a=function(){let s,c,u;return s=rr(),s===r&&(s=n,i.charCodeAt(n)===46?(c=Pe,n++):(c=r,y===0&&h(Re)),c!==r?(u=Ge(),u===r&&(u=ze()),u!==r?(E=s,s=function(p){return[p]}(u)):(n=s,s=r)):(n=s,s=r)),s}(),a===r&&(a=function(){let s,c,u;return s=n,i.substr(n,2)===Et?(c=Et,n+=2):(c=r,y===0&&h(la)),c!==r?(u=rr(),u===r&&(u=Ge(),u===r&&(u=ze())),u!==r?(E=s,s=function(p){return Array.isArray(p)?{type:"DescendantSegment",selectors:p}:{type:"DescendantSegment",selectors:[p]}}(u)):(n=s,s=r)):(n=s,s=r),s}()),a}function rr(){let a,s,c,u,p,f,b,A;if(a=n,i.charCodeAt(n)===91?(s=ke,n++):(s=r,y===0&&h(De)),s!==r)if(I(),c=He(),c!==r){for(u=[],p=n,f=I(),i.charCodeAt(n)===44?(b=he,n++):(b=r,y===0&&h(Ae)),b!==r?(I(),A=He(),A!==r?p=A:(n=p,p=r)):(n=p,p=r);p!==r;)u.push(p),p=n,f=I(),i.charCodeAt(n)===44?(b=he,n++):(b=r,y===0&&h(Ae)),b!==r?(I(),A=He(),A!==r?p=A:(n=p,p=r)):(n=p,p=r);p=I(),i.charCodeAt(n)===93?(f=Me,n++):(f=r,y===0&&h(je)),f!==r?(E=a,a=function(N,P){return[N].concat(P)}(c,u)):(n=a,a=r)}else n=a,a=r;else n=a,a=r;return a}function ze(){let a,s,c,u;if(a=n,s=nr(),s!==r){for(c=[],u=ar();u!==r;)c.push(u),u=ar();E=a,a={type:"MemberNameShorthand",member:oe()}}else n=a,a=r;return a}function nr(){let a,s,c,u;return a=function(){let p;return p=i.charAt(n),Nn.test(p)?n++:(p=r,y===0&&h(ua)),p}(),a===r&&(a=i.charAt(n),Sn.test(a)?n++:(a=r,y===0&&h(ia)),a===r&&(a=n,s=n,c=i.charAt(n),St.test(c)?n++:(c=r,y===0&&h(Nt)),c!==r?(u=i.charAt(n),Tt.test(u)?n++:(u=r,y===0&&h(Ot)),u!==r?(c=[c,u],s=c):(n=s,s=r)):(n=s,s=r),a=s!==r?i.substring(a,n):s)),a}function ar(){let a;return a=X(),a===r&&(a=nr()),a}function X(){let a;return a=i.charAt(n),Tn.test(a)?n++:(a=r,y===0&&h(ca)),a}g=D();let Je=g!==r&&n===i.length;function sr(){throw g!==r&&n<i.length&&h({type:"end"}),a=xe,s=Y<i.length?function(u=n){let p=i.codePointAt(u);return p===void 0?"":String.fromCodePoint(p)}(Y):null,c=Y<i.length?Lt(Y,Y+1):Lt(Y,Y),new l(l.buildMessage(a,s),a,s,c);var a,s,c}return d.peg$library?{peg$result:g,peg$currPos:n,peg$FAILED:r,peg$maxFailExpected:xe,peg$maxFailPos:Y,peg$success:Je,peg$throw:Je?void 0:sr}:Je?g:void sr()}}},()=>(Se||fr((Se={exports:{}}).exports,Se),Se.exports)),Ra=((e,t,o)=>(o=e!=null?Ma($a(e)):{},((l,i,d,g)=>{if(i&&typeof i=="object"||typeof i=="function")for(let r of La(i))!Da.call(l,r)&&r!==d&&gr(l,r,{get:()=>i[r],enumerable:!(g=Pa(i,r))||g.enumerable});return l})(e&&e.__esModule?o:gr(o,"default",{value:e,enumerable:!0}),e)))(ja()),$r=Symbol("NodeType");function st(e,t){return{[$r]:void 0,value:e,path:t}}function ot(e,t,o){return st(t,[...e.path,o])}function de(e,t,o){return st(t,[...e.path,o])}function Dr(e){return typeof e=="object"&&e!==null&&$r in e}function jr(e){return!!Array.isArray(e)&&e.every(Dr)}var ie=e=>e!==null&&typeof e=="object"&&!Array.isArray(e),it=e=>e===null||e===!0||e===!1||typeof e=="string"||typeof e=="number",rt=e=>Array.isArray(e);function Rr(e){let{value:t}=e;return it(t)?[]:rt(t)?t.map((o,l)=>de(e,o,l)):ie(t)?Object.entries(t).map(([o,l])=>ot(e,l,o)):[]}var Br=e=>{let t=[];t.push(e);for(let o of Rr(e))t.push(...Br(o));return t};function Ba(e,t){if(!Array.isArray(t.value))return[];let o=e.step??1,l=e.start??(o>=0?0:t.value.length-1),i=e.end??(o>=0?t.value.length:-t.value.length-1),d=[],[g,r]=function(v,M,D,k){let j,W,_=hr(v,k),F=hr(M,k);return D>=0?(j=Math.min(Math.max(_,0),k),W=Math.min(Math.max(F,0),k)):(W=Math.min(Math.max(_,-1),k-1),j=Math.min(Math.max(F,-1),k-1)),[j,W]}(l,i,o,t.value.length);if(o>0)for(let v=g;v<r;v+=o)d.push(de(t,t.value[v],v));else if(o<0)for(let v=r;g<v;v+=o)d.push(de(t,t.value[v],v));return d}function hr(e,t){return e>=0?e:t+e}function te(e,t){return nt(e,t)}function nt(e,t,o=new WeakMap){if(e===t)return!0;if(typeof e!=typeof t||e===null||t===null)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((l,i)=>nt(l,t[i],o));if(Array.isArray(e)||Array.isArray(t))return!1;if(typeof e=="object"&&typeof t=="object"){if(o.has(e))return o.get(e)===t;o.set(e,t);let l=Object.keys(e),i=Object.keys(t);return l.length===i.length&&l.every(d=>nt(e[d],t[d],o))}return!1}var U,yr,Ha={"==":(e,t)=>te(e,t),"!=":(e,t)=>!te(e,t),"<":()=>!1,"<=":(e,t)=>te(e,t),">":()=>!1,">=":(e,t)=>te(e,t)},Ga={"==":(e,t)=>e===t,"!=":(e,t)=>e!==t,"<":()=>!1,"<=":(e,t)=>e===t,">":()=>!1,">=":(e,t)=>e===t},B={__type:"Nothing"},qa={"==":(e,t)=>(e===B||t===B)&&e===t,"!=":(e,t)=>(e===B||t===B)&&e!==t,"<":()=>!1,"<=":(e,t)=>(e===B||t===B)&&e===t,">":()=>!1,">=":(e,t)=>(e===B||t===B)&&e===t},Wa={"==":(e,t)=>e===t,"!=":(e,t)=>e!==t,"<":()=>!1,"<=":(e,t)=>e===t,">":()=>!1,">=":(e,t)=>e===t},Va={"==":(e,t)=>e===t,"!=":(e,t)=>e!==t,"<":(e,t)=>typeof t=="number"&&e<t,"<=":(e,t)=>typeof t=="number"&&e<=t,">":(e,t)=>typeof t=="number"&&e>t,">=":(e,t)=>typeof t=="number"&&e>=t},Ua={"==":(e,t)=>te(e,t),"!=":(e,t)=>!te(e,t),"<":()=>!1,"<=":(e,t)=>te(e,t),">":()=>!1,">=":(e,t)=>te(e,t)},Ya={"==":(e,t)=>e===t,"!=":(e,t)=>e!==t,"<":(e,t)=>e<t,"<=":(e,t)=>e<=t,">":(e,t)=>e>t,">=":(e,t)=>e>=t};(yr=U||(U={})).LogicalTrue={type:"LogicalType"},yr.LogicalFalse={type:"LogicalFalse"};var Hr=e=>e?U.LogicalTrue:U.LogicalFalse,br=e=>e===U.LogicalTrue||e===U.LogicalFalse,re={type:"ValueType",convert:e=>{if(e===B||it(e))return e;if(Dr(e))return e.value;if(jr(e)){if(e.length===0)return B;if(e.length===1)return e[0].value}throw new Error(`Invalid argument type "${JSON.stringify(e)}" is not a ValueType`)}},Gr={type:"NodesType",convert:e=>{if(jr(e))return e;throw new Error(`Invalid argument type "${JSON.stringify(e)}" is not a NodesType`)}},qr={type:"LogicalType",convert:e=>{if(e===!0)return U.LogicalTrue;if(e===!1)return U.LogicalFalse;if(Array.isArray(e)){if(e.length===0)return U.LogicalFalse;if(e.length>=1)return U.LogicalTrue}throw new Error(`Invalid argument type "${JSON.stringify(e)}" is not a LogicalType`)}},me=(e,t)=>{let o=e.args;if(t.length!==o.length)throw new Error(`Invalid number of arguments: ${e.name} function requires ${o.length} arguments but received ${t.length}`);return o.map((l,i)=>l.convert(t[i]))},za={name:"length",args:[Gr],return:re,function:e=>e.length},Ja={name:"length",args:[re],return:re,function:e=>e===B?B:typeof e=="string"||Array.isArray(e)?e.length:ie(e)?Object.keys(e).length:B},Wr=e=>{let t="",o=!1,l=!1;for(let i=0;i<e.length;i++){let d=e[i];l?(t+=`\\${d}`,l=!1):d!=="\\"?d!=="["?d!=="]"?t+=d!=="."||o||l?d:"[^\\n\\r]":(o=!1,t+=d):(o=!0,t+=d):l=!0}if(l)throw new Error("Invalid I-Regexp: ends with a backslash escape.");return t},Xa={name:"match",args:[re,re],return:qr,function:(e,t)=>{if(typeof e!="string"||typeof t!="string")return U.LogicalFalse;let o=Wr(t),l=new RegExp(`^(?:${o})$`,"u").test(e);return Hr(l)}},Ka={name:"search",args:[re,re],return:qr,function:(e,t)=>{if(typeof e!="string"||typeof t!="string")return U.LogicalFalse;let o=Wr(t),l=new RegExp(o,"u").test(e);return Hr(l)}},Za={name:"value",args:[Gr],return:re,function:e=>e.length===1?e[0].value:B},J={length:Ja,count:za,match:Xa,search:Ka,value:Za},ct=(e,t,o)=>{let l=e.args.map(i=>Qa(i,t,o));switch(e.name){case"length":{let i=me(J.length,l);return J.length.function.call(void 0,...i)}case"count":{let i=me(J.count,l);return J.count.function.call(void 0,...i)}case"match":{let i=me(J.match,l);return J.match.function.call(void 0,...i)}case"search":{let i=me(J.search,l);return J.search.function.call(void 0,...i)}case"value":{let i=me(J.value,l);return J.value.function.call(void 0,...i)}}return B},Qa=(e,t,o)=>{switch(e.type){case"Literal":return e.member;case"CurrentNode":return ut(e,t,[o]);case"Root":return _e(e,t);case"FunctionExpr":return ct(e,t,o);default:throw new Error(`Unknown argument type "${e.type}"`)}},ce=(e,t,o)=>{switch(e.type){case"ComparisonExpr":return es(e,t,o);case"TestExpr":return rs(e,t,o);case"LogicalBinary":case"LogicalUnary":return as(e,t,o)}return!1},es=(e,t,o)=>{let l=Ar(e.left,t,o),i=Ar(e.right,t,o);return ts(l,i,e.operator)},ts=(e,t,o)=>{if(e===B||t===B)return qa[o](e,t);let l=e,i=t;if(br(l)||br(i))throw new Error("LogicalType can't be compared");return ie(l)&&ie(i)?Ua[o](l,i):rt(l)&&rt(i)?Ha[o](l,i):typeof l=="number"&&typeof i=="number"?Va[o](l,i):typeof l=="string"&&typeof i=="string"?Ya[o](l,i):typeof l=="boolean"&&typeof i=="boolean"?Ga[o](l,i):l===null&&i===null?Wa[o](l,i):o==="!="},ut=(e,t,o)=>Vr(e.segments,t,o),Ar=(e,t,o)=>{var l;switch(e.type){case"Literal":return e.member;case"CurrentNode":{let i=ut(e,t,[o]);return i[0]===void 0?B:i[0].value}case"Root":return((l=_e(e,t)[0])==null?void 0:l.value)??B;case"FunctionExpr":return ct(e,t,o)}},rs=(e,t,o)=>ns(e.query,t,o),ns=(e,t,o)=>{switch(e.type){case"FunctionExpr":{let l=ct(e,t,o);if(l===U.LogicalTrue)return!0;if(l===U.LogicalFalse)return!1;if(Array.isArray(l))return l.length>0;throw new Error(`Function ${e.name} result must be compared`)}case"CurrentNode":return ut(e,t,[o]).length>0;case"Root":return _e(e,t).length>0}return!1},as=(e,t,o)=>{switch(e.operator){case"||":return ss(e,t,o);case"&&":return os(e,t,o);case"!":return is(e,t,o)}},ss=(e,t,o)=>{let l=ce(e.left,t,o),i=ce(e.right,t,o);return l||i},os=(e,t,o)=>{let l=ce(e.left,t,o),i=ce(e.right,t,o);return l&&i},is=(e,t,o)=>!ce(e.expr,t,o);function _e(e,t){return Vr(e.segments,t,[t])}function Vr(e,t,o){return e.reduce((l,i)=>l.flatMap(d=>function(g,r,v){return Array.isArray(g)?g.map(M=>xr(M,r,v)).flat().filter(M=>M!==void 0):Br(v).flatMap(M=>g.selectors.flatMap(D=>xr(D,r,M)))}(i,t,d)),o)}function xr(e,t,o){let l=e.type;switch(l){case"WildcardSelector":return function(i,d){let g=[],r=d.value;if(Array.isArray(r))for(let v in r)Object.hasOwn(r,v)&&g.push(de(d,r[v],Number(v)));else if(ie(r))for(let v in r)Object.hasOwn(r,v)&&g.push(ot(d,r[v],v));return g}(0,o);case"IndexSelector":return function(i,d){if(Array.isArray(d.value)){let g=i.index<0?d.value.length+i.index:i.index;if(0<=g&&g<d.value.length){let r=d.value.at(g);return r===void 0?[]:[de(d,r,g)]}return[]}return[]}(e,o);case"SliceSelector":return Ba(e,o);case"MemberNameShorthand":case"NameSelector":return cs(e,o);case"FilterSelector":return function(i,d,g){return it(g.value)?[]:Rr(g).filter(r=>ce(i.expr,d,r))}(e,t,o);default:return l}}function cs(e,t){return ie(t.value)&&e.member in t.value?[ot(t,t.value[e.member],e.member)]:[]}function vr(e,t){return _e(t,st(e,["$"]))}var Fe,Ur,Tr,Cr=(Tr=class{constructor(e){cr(this,Fe);ir(this,"rootNode");let t=(0,Ra.parse)(e);this.rootNode=t}find(e){return vr(e,this.rootNode).filter(t=>t!==void 0).map(t=>t.value)}paths(e){return this.pathSegments(e).map(t=>({value:t.value,path:"$"+t.segments.map(o=>ur(this,Fe,Ur).call(this,o)).join("")}))}pathSegments(e){return vr(e,this.rootNode).filter(t=>t!==void 0).map(t=>({value:t.value,segments:t.path.slice(1)}))}},Fe=new WeakSet,Ur=function(e){return typeof e=="string"?e==="$"?"$":`['${(t=>t.replace(/['\\\b\f\n\r\t\u0000-\u001F]/g,o=>{switch(o){case"'":return"\\'";case"\\":return"\\\\";case"\b":return"\\b";case"\f":return"\\f";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";default:return`\\u${o.charCodeAt(0).toString(16).padStart(4,"0")}`}}))(e)}']`:`[${e}]`},Tr);const us=(e,t,o)=>e.reduce((l,{segments:i,value:d})=>{if(typeof d=="object")return l;const g=i[i.length-1];if(typeof g=="number")return l;const r=t.objectSchema[g];if(!r)return l;const v={value:d,structName:o,param:{name:g,attr:r}};return[...l,v]},[]),ls=e=>(e.data.kind==="struct_def"||e.data.kind==="struct_def[]")&&!!e.data.struct,Yr=(e,t)=>({type:"array",items:t,...G(e),...q(e.default)}),G=e=>({...typeof e.text=="string"?{title:e.text}:{},...typeof e.desc=="string"?{description:e.desc}:{}}),q=e=>e!==void 0?{default:e}:{},ms="x-rpg-param",ae=(e,t)=>({[ms]:{kind:e.kind,...e.parent?{parent:e.parent}:{},data:t}}),ps=e=>ae(e,{...typeof e.on=="string"?{on:e.on}:{},...typeof e.off=="string"?{off:e.off}:{}}),Ne=e=>e===void 0||e===0,Er=e=>ae(e,typeof e.decimals=="number"?{decimals:e.decimals}:{}),zr=e=>({$ref:`#/definitions/${e.struct}`,...G(e)}),Jr=e=>Yr(e,{type:"string"}),Xr=e=>Yr(e,{type:"integer"}),lt=e=>{switch(e.kind){case"string":case"multiline_string":return(t=>({type:"string",...G(t),...q(t.default)}))(e);case"file":case"combo":return(t=>({type:"string",...q(t.default),...G(t)}))(e);case"select":return(t=>({type:"string",...q(t.default),...G(t),...t.options?{enum:t.options.map(o=>o.value)}:{}}))(e);case"file[]":case"string[]":case"multiline_string[]":return Jr(e);case"number[]":return(t=>({type:"array",items:{type:Ne(t.decimals)?"integer":"number"},...q(t.default),...G(t)}))(e);case"actor[]":case"weapon[]":case"armor[]":case"skill[]":case"item[]":case"enemy[]":case"state[]":case"class[]":case"troop[]":return Xr(e);case"number":return(t=>({type:Ne(t.decimals)?"integer":"number",...q(t.default),...G(t)}))(e);case"actor":case"weapon":case"armor":case"skill":case"item":case"enemy":case"state":case"class":case"troop":return(t=>({type:"integer",...q(t.default),...G(t)}))(e);case"boolean":return(t=>({type:"boolean",...q(t.default),...G(t)}))(e);case"struct":return zr(e);default:return{}}},Kr=e=>{switch(e.kind){case"string":case"multiline_string":return(t=>({type:"string",...G(t),...q(t.default),...ae(t,{})}))(e);case"file":return(t=>({type:"string",...q(t.default),...G(t),...ae(t,{dir:t.dir})}))(e);case"combo":return(t=>({type:"string",...q(t.default),...G(t),...ae(t,{options:[...t.options]})}))(e);case"select":return(t=>({type:"string",...q(t.default),...G(t),enum:t.options.map(o=>o.value),...ae(t,{options:t.options.map(o=>({value:o.value,option:o.option}))})}))(e);case"file[]":case"string[]":case"multiline_string[]":return Jr(e);case"number[]":return(t=>({type:"array",items:{type:Ne(t.decimals)?"integer":"number"},...q(t.default),...G(t),...Er(t)}))(e);case"actor[]":case"weapon[]":case"armor[]":case"skill[]":case"item[]":case"enemy[]":case"state[]":case"class[]":case"troop[]":return Xr(e);case"number":return(t=>({type:Ne(t.decimals)?"integer":"number",...q(t.default),...G(t),...Er(t)}))(e);case"actor":case"weapon":case"armor":case"skill":case"item":case"enemy":case"state":case"class":case"troop":return(t=>({type:"integer",...q(t.default),...G(t),...ae(t,pe.lookupKind(t.kind))}))(e);case"boolean":return(t=>({type:"boolean",...q(t.default),...G(t),...ps(t)}))(e);case"struct":return zr(e);default:return{}}},Sr=e=>{const t=Object.entries(e).reduce((o,[l,i])=>{const d=lt(i);return{...o,[l]:d}},{});return{type:"object",properties:t,required:Object.keys(t),additionalProperties:!1}},Te=(e,t,o,l)=>{const{properties:i,logs:d}=ds(o,e,l);return{schema:{type:"object",title:t,properties:i,required:Object.keys(o),additionalProperties:!1},logs:d}},Zr=e=>e.kind==="struct_def",Qr=e=>e.kind==="struct_def[]",ds=(e,t,o)=>Object.entries(e).reduce((l,i)=>((d,[g,r],v,M)=>{const D=`${v}.${g}`,k=fs(D,r,M);return{properties:{...d.properties,[g]:k.schema},logs:[...d.logs,...k.logs,{structName:(j=r,Qr(j)||Zr(j)?j.struct:""),path:D,data:r,schema:k.schema}]};var j})(l,i,t,o),{properties:{},logs:[]}),fs=(e,t,o)=>Zr(t)?en(e,t,o):Qr(t)?gs(e,t,o):{schema:o.options.kindData?Kr(t):lt(t),logs:[]},en=(e,t,o)=>Te(e,t.struct,t.params,o),gs=(e,t,o)=>{const l=en(`${e}[]`,{params:t.params,struct:t.struct},o);return{schema:{type:"array",...l.schema?{items:l.schema}:{},...q(t.default)},logs:l.logs}},S={type:"string",nullable:!0,maxLength:100},Z={type:"string",default:"",nullable:!1},Oe={type:"number",nullable:!0},hs={additionalProperties:!1,type:"object",required:["kind","default"],properties:{kind:{type:"string",const:"boolean"},default:{type:"boolean",default:!0},on:S,off:S,desc:S,text:S,parent:S}},ys={type:"object",required:["kind","default"],properties:{decimals:{type:"integer",minimum:0,default:0,nullable:!0},min:Oe,max:Oe,default:{type:"number",default:0},kind:{type:"string",const:"number"},desc:S,text:S,parent:S}},bs={additionalProperties:!1,type:"object",required:["kind","default"],properties:{kind:{type:"string",const:"number[]"},default:{type:"array",items:{type:"number",default:0},default:[]},decimals:{type:"integer",minimum:0,default:0,nullable:!0},min:Oe,max:Oe,desc:S,text:S,parent:S}},As={additionalProperties:!1,type:"object",required:["kind","default"],properties:{kind:{type:"string",const:"string"},default:Z,desc:S,text:S,parent:S}},xs={additionalProperties:!1,type:"object",required:["kind","default"],properties:{kind:{type:"string",const:"string[]"},default:{type:"array",items:Z,default:[]},desc:S,text:S,parent:S}},vs={additionalProperties:!1,type:"object",required:["kind","default"],properties:{kind:{type:"string",enum:["actor","class","skill","item","weapon","armor","enemy","state","common_event"]},default:{type:"integer",default:0},desc:S,text:S,parent:S}},Cs={additionalProperties:!1,type:"object",required:["kind","default","options"],properties:{kind:{type:"string",const:"combo"},default:Z,options:{type:"array",items:{type:"string"},default:[]},desc:S,text:S,parent:S}},Es={additionalProperties:!1,type:"object",required:["kind","default","dir"],properties:{kind:{type:"string",const:"file"},default:Z,dir:Z,desc:S,text:S,parent:S}},Ss={additionalProperties:!1,type:"object",required:["kind","default","dir"],properties:{kind:{type:"string",const:"file[]"},default:{type:"array",items:{type:"string"},default:[]},dir:Z,desc:S,text:S,parent:S}},tn={type:"string",pattern:"^[a-zA-Z][a-zA-Z0-9]*$",minLength:1,maxLength:48},Ts={additionalProperties:!1,type:"object",required:["kind","struct"],properties:{kind:{type:"string",const:"struct"},default:{type:"object",default:{},nullable:!0},desc:S,text:S,parent:S,struct:tn}},Ns={additionalProperties:!1,type:"object",required:["kind","struct"],properties:{kind:{type:"string",const:"struct[]"},struct:tn,default:{type:"array",items:{type:"object"},default:[],nullable:!0},desc:S,text:S,parent:S}},Os={additionalProperties:!1,type:"object",required:["kind","default","options"],properties:{kind:{type:"string",const:"select"},default:Z,options:{type:"array",items:{type:"object",properties:{value:Z,option:Z},required:["value","option"]},default:[]},desc:S,text:S,parent:S}};exports.buildReferenceItemSources=(e,t,o,l,i,d)=>[...x.defineTraitItems(o,l),...x.defineGameDataSources(e,t),...x.defineSystemItems(i,d)],exports.compileFlatStruct=Sr,exports.compileItemEffectDisplayData=(e,t,o)=>{const l=x.resolveItemEffectLabels(t);return lr.mergeItemsSource(o?[...l,...o]:l,e)},exports.compilePluginCommand=(e,{args:t,command:o},l)=>Te(`${e.moduleName}.command.${o}`,o,t,{options:l}),exports.compilePluginStruct=(e,{params:t,struct:o},l)=>Te(`${e.moduleName}.${o}`,o,t,{options:l}),exports.compilePrimitiveField=lt,exports.compilePrimitiveFieldWithXParam=Kr,exports.compileStructDetail=Te,exports.compileTraitDisplayData=(e,t)=>lr.mergeItemsSource(x.resolveTraitLabels(t),e),exports.defineStructs=e=>e.filter(t=>ls(t)).reduce((t,o)=>({...t,[o.structName]:o.schema}),{}),exports.extractArrayValuesFromJson=(e,t)=>t.scalaArrays.map(o=>((l,i)=>{const d=new Cr(i.path).find(l);if(!Array.isArray(d))return null;const g=i.param.attr;return pe.isStringArrayParam(g)?{values:d.filter(v=>typeof v=="string"),valueKind:"string",param:{name:i.param.name,attr:g}}:pe.isNumberArrayParam(g)?{values:d.filter(v=>typeof v=="number"),valueKind:"number",param:{name:i.param.name,attr:g}}:null})(e,o)).filter(o=>o!==null),exports.extractBattleEventTexts=(e,t=()=>[])=>((o,l)=>o.map(i=>et(i,l)))(e,(o,l,{id:i})=>({eventId:i,pageIndex:l,commands:tt(o.list,t)})),exports.extractCommonEventTexts=(e,t=()=>[])=>{return o=(l,i,{id:d})=>({eventId:d,commands:tt(l.list,t)}),e.map(l=>o(l,0,l));var o},exports.extractImageFromActor=e=>[Qe(e,"faceName","faces"),Qe(e,"characterName","characters"),Qe(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractItemChangeData=Nr,exports.extractItemCommands=Xe,exports.extractItemFromMap=(e,t,o)=>Or(e.map,(l,i,d)=>({...ya(l),commands:Xe(l.list,t,o),eventName:d.name,pageIndex:i})),exports.extractItemFromTroop=(e,t,o)=>{return l=(i,d,g)=>({commands:Xe(i.list,t,o),eventName:g.name,troopId:g.id,pageIndex:d}),e.flatMap(i=>et(i,l));var l},exports.extractMapText=(e,t=()=>[])=>({note:e.note,noteItems:x.readNote(e.note),displayedName:e.displayName,events:_a(e,t)}),exports.extractNoteText=Lr,exports.extractScalaValuesFromJson=(e,t)=>{if(!t.scalas)return[];const o=new Cr(t.scalas).pathSegments(e);return us(o,t,t.structName)},exports.extractTextData=K,exports.extractTextFromActor=e=>K(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>K(e,["name","description"]),exports.extractTextFromClass=e=>K(e,["name"]),exports.extractTextFromEnemy=e=>K(e,["name"]),exports.extractTextFromEventCommands=e=>Pr(e,()=>[]),exports.extractTextFromItem=e=>K(e,["name","description"]),exports.extractTextFromSkill=e=>K(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>K(e,["name","message1","message2","message3","message4"]),exports.extractTextFromSystem=e=>({gameTitle:e.gameTitle,currencyUnit:e.currencyUnit,equipTypes:[...e.equipTypes],armorTypes:[...e.armorTypes],weaponTypes:[...e.weaponTypes],terms:{basic:x.makeTermsBasicFromArray(e.terms.basic),commands:x.makeTermsCommandFromArray(e.terms.commands),messages:x.makeTermsMessages(e.terms.messages),params:x.makeParamNamesFromArray(e.terms.params)}}),exports.extractTextFromWeapon=e=>K(e,["name","description"]),exports.getPathFromStructParam=function(e,t,o,l=pr){const i=e.map(d=>dr(d.attr.struct,`${t}.${d.name}`,o,l));return{items:i.flatMap(d=>d.items),errors:i.flatMap(d=>d.errors)}},exports.getPathFromStructSchema=function(e,t,o,l=pr){return dr(e,t,o,l)},exports.makePluginParamSchema=()=>({type:"object",discriminator:{propertyName:"kind"},oneOf:[hs,Cs,vs,Es,Ss,ys,bs,Os,Ts,Ns,As,xs]}),exports.replaceActorText=(e,t)=>{const o=ee(e,t),l=m(e.name,t),i=m(e.nickname,t),d=m(e.profile,t);return{...e,name:l,nickname:i,profile:d,note:o}},exports.replaceArmorText=Ke,exports.replaceClassText=(e,t)=>{const o=ee(e,t),l=m(e.name,t);return{...e,name:l,note:o}},exports.replaceCommonEventTexts=(e,t)=>({...e,list:Ee(e.list,t)}),exports.replaceEnemyText=(e,t)=>{const o=ee(e,t),l=m(e.name,t);return{...e,name:l,note:o}},exports.replaceEventCommandTexts=Ee,exports.replaceItemText=Ke,exports.replaceMapDataTexts=(e,t)=>{const o=m(e.displayName,t),l=ee(e,t),i={displayName:o,events:x.repleaceMapEventCommands(e,d=>Ee(d,t)),note:l};return{...e,...i}},exports.replaceNoteTextByMap=ee,exports.replaceSkillText=(e,t)=>{const o=ee(e,t),l=m(e.name,t),i=m(e.description,t),d=m(e.message1,t),g=m(e.message2,t);return{...e,name:l,description:i,message1:d,message2:g,note:o}},exports.replaceStateText=(e,t)=>{const o=ee(e,t),l=m(e.name,t),i=m(e.message1,t),d=m(e.message2,t),g=m(e.message3,t),r=m(e.message4,t);return{...e,name:l,message1:i,message2:d,message3:g,message4:r,note:o}},exports.replaceSystemTerms=mr,exports.replaceSystemText=(e,t)=>({...e,gameTitle:m(e.gameTitle,t),currencyUnit:m(e.currencyUnit,t),elements:le(e.elements,t),skillTypes:le(e.skillTypes,t),weaponTypes:le(e.weaponTypes,t),armorTypes:le(e.armorTypes,t),equipTypes:le(e.equipTypes,t),terms:mr(e.terms,t)}),exports.replaceTextByMap=m,exports.replaceTextForCommand=Fr,exports.replaceTextForCommandActor=_r,exports.replaceTextForCommandShowChoices=wr,exports.replaceTextForCommandShowMessage=Ir,exports.replaceTroopTexts=(e,t)=>{const o=e.pages.map(l=>({list:Ee(l.list,t),conditions:l.conditions,span:l.span}));return{...e,pages:o}},exports.replaceWeaponText=Ke,exports.structToJSONSchema=e=>Sr(e);
