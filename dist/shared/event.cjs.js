"use strict";const s=require("./make.cjs3.js"),g=require("./mergeItemsSource.cjs.js"),S=e=>e.map(a=>a.parameters[0].trimEnd()).join(`
`).trimEnd();class h{constructor(a,r){this.header=a,this.bodies=r}getBodyText(){return S(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class E{constructor(a,r,t){this.bodyCode=a,this.header=r,this.bodies=t}normalizedCommands(){const a={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[a]:[a,this.mergedBody()]}getBodyText(){return S(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const T=(e,a,r,t)=>{const n=e[a];if(!r(n))throw new Error(`Invalid head at index ${a}: ${JSON.stringify(n)}`);const o=[];for(let d=a+1;d<e.length;d++){const p=e[d];if(!t(p))break;o.push(p)}return{header:n,bodies:o}},N=(e,a)=>{const{bodies:r,header:t}=((n,o)=>T(n,o,d=>d.code===s.COMMENT_HEAD,d=>d.code===s.COMMENT_BODY))(e,a);return _(t)?new E(s.COMMENT_BODY,t,r):new h(t,r)},_=e=>e.parameters[0]==="選択肢ヘルプ",O=(e,a)=>{const{bodies:r,header:t}=((n,o)=>T(n,o,d=>d.code===s.SHOW_MESSAGE,d=>d.code===s.SHOW_MESSAGE_BODY))(e,a);return new E(s.SHOW_MESSAGE_BODY,t,r)},I=(e,a)=>{const{bodies:r,header:t}=((n,o)=>T(n,o,s.isCommandScriptHeader,s.isCommandScriptBody))(e,a);return new h(t,r)},M=(e,a)=>{const{bodies:r,header:t}=((n,o)=>T(n,o,s.isCommandScrollTextHead,s.isCommandShowScrollingTextBody))(e,a);return new E(s.SHOW_SCROLLING_TEXT_BODY,t,r)},A={[s.SHOW_MESSAGE]:(e,a,r)=>r.showMessage(O(e,a),a,e),[s.SCRIPT_EVAL]:(e,a,r)=>r.script(I(e,a),a,e),[s.COMMENT_HEAD]:(e,a,r)=>r.comment(N(e,a),a,e),[s.SHOW_SCROLLING_TEXT]:(e,a,r)=>r.showScrollingText(M(e,a),a,e)},B=e=>((a,r)=>({code:a.code,paramIndex:r,value:a.parameters[r]}))(e,1),v=e=>e.parameters[0].map((a,r)=>({code:102,paramIndex:r,value:a})),l=e=>e.reduce((a,r,t)=>{if(r.code===s.SHOW_CHOICES)return[...a,...v(r)];const n=(o=r.code,A[o]);var o;if(n){const d=n(e,t,H);if(d!==void 0)return[...a,d]}return r.code===s.CHANGE_NICKNAME||r.code===s.CHANGE_NAME||r.code===s.CHANGE_PROFILE?[...a,B(r)]:a},[]),H={comment:e=>{return a=e,{code:s.COMMENT_HEAD,paramIndex:0,value:a.getBodyText()};var a},showMessage:e=>{return a=e,{code:s.SHOW_MESSAGE_BODY,paramIndex:0,value:a.getBodyText(),speaker:(r=a.header,r.parameters[4]?r.parameters[4].trimEnd():"")};var a,r},script:e=>(a=>({code:s.SCRIPT_EVAL,paramIndex:0,value:a.getBodyText()}))(e),showScrollingText:e=>(a=>({code:s.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:a.getBodyText()}))(e)},f=e=>!!e,y=(e,a)=>e.pages.map((r,t)=>a(r,t,e)),b=(e,a)=>((r,t)=>r.events.filter(f).map(n=>y(n,t)))(e,a).flat(1),D=e=>b(e,(a,r,t)=>({eventId:t.id,pageIndex:r,commands:l(a.list),note:t.note,noteItems:[],name:t.name})),x=(e,a,r)=>({folder:r,key:a,image:e[a],id:e.id}),i=(e,a)=>({note:C(e),main:a.map(r=>({key:r,text:e[r],id:e.id}))}),C=e=>s.readNoteEx(e.note,(a,r)=>({key:a,text:r,id:e.id})),m=(e,a)=>{const r=e.trimEnd(),t=a.get(r);return t!==void 0?t.trimEnd():r},c=(e,a)=>s.replaceNote(e.note,r=>m(r.value,a)),u=(e,a)=>e.map(r=>{switch(r.code){case s.SHOW_MESSAGE:return G(r,a);case s.SHOW_CHOICES:return w(r,a);case s.SHOW_MESSAGE_BODY:case s.COMMENT_HEAD:case s.COMMENT_BODY:case s.SHOW_SCROLLING_TEXT_BODY:return k(r,a);case s.CHANGE_NAME:case s.CHANGE_NICKNAME:case s.CHANGE_PROFILE:return F(r,a);default:return r}}),k=(e,a)=>{const r=m(e.parameters[0],a);return{code:e.code,indent:e.indent,parameters:[r]}},G=(e,a)=>{const r=m(e.parameters[4],a);return s.makeCommandShowMessage({facename:e.parameters[0],faceIndex:e.parameters[1],background:e.parameters[2],positionType:e.parameters[3],speakerName:r},e.indent)},F=(e,a)=>{const r=m(e.parameters[1],a);return{code:e.code,indent:e.indent,parameters:[e.parameters[0],r]}},w=(e,a)=>{const r=e.parameters[0].map(t=>m(t,a));return{code:e.code,indent:e.indent,parameters:[r,e.parameters[1],e.parameters[2],e.parameters[3],e.parameters[4]]}};exports.buildReferenceItemSources=(e,a,r,t,n,o)=>[...s.defineTraitItems(r,t),...s.defineGameDataSources(e,a),...s.defineSystemItems(n,o)],exports.compileItemEffectDisplayData=(e,a,r)=>{const t=s.resolveItemEffectLabels(a);return g.mergeItemsSource(r?[...t,...r]:t,e)},exports.compileTraitDisplayData=(e,a)=>g.mergeItemsSource(s.resolveTraitLabels(a),e),exports.extractBattleEventTexts=e=>((a,r)=>a.map(t=>y(t,r)))(e,(a,r,{id:t})=>({eventId:t,pageIndex:r,commands:l(a.list)})),exports.extractCommonEventTexts=e=>{return a=(r,t,{id:n})=>({eventId:n,commands:l(r.list)}),e.map(r=>a(r,0,r));var a},exports.extractImageFromActor=e=>[x(e,"faceName","faces"),x(e,"characterName","characters"),x(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractMapText=e=>({note:e.note,noteItems:s.readNote(e.note),displayedName:e.displayName,events:D(e)}),exports.extractNoteText=C,exports.extractTextData=i,exports.extractTextFromActor=e=>i(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>i(e,["name","description"]),exports.extractTextFromClass=e=>i(e,["name"]),exports.extractTextFromEnemy=e=>i(e,["name"]),exports.extractTextFromEventCommands=l,exports.extractTextFromItem=e=>i(e,["name","description"]),exports.extractTextFromSkill=e=>i(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>i(e,["name","message1","message2","message3","message4"]),exports.extractTextFromSystem=e=>({gameTitle:e.gameTitle,currencyUnit:e.currencyUnit,equipTypes:[...e.equipTypes],armorTypes:[...e.armorTypes],weaponTypes:[...e.weaponTypes],terms:{basic:s.makeTermsBasicFromArray(e.terms.basic),commands:s.makeTermsCommandFromArray(e.terms.commands),messages:s.makeTermsMessages(e.terms.messages),params:s.makeParamNamesFromArray(e.terms.params)}}),exports.extractTextFromWeapon=e=>i(e,["name","description"]),exports.replaceActorText=(e,a)=>{const r=c(e,a),t=m(e.name,a),n=m(e.nickname,a),o=m(e.profile,a);return{...e,name:t,nickname:n,profile:o,note:r}},exports.replaceClassText=(e,a)=>{const r=c(e,a),t=m(e.name,a);return{...e,name:t,note:r}},exports.replaceCommonEventTexts=(e,a)=>({...e,list:u(e.list,a)}),exports.replaceEnemyText=(e,a)=>{const r=c(e,a),t=m(e.name,a);return{...e,name:t,note:r}},exports.replaceItemText=(e,a)=>{const r=c(e,a),t=m(e.name,a),n=m(e.description,a);return{...e,name:t,description:n,note:r}},exports.replaceMapTexts=(e,a)=>{const r=m(e.displayName,a),t=s.replaceNote(e.note,o=>m(o.value,a)),n={events:s.repleaceEventCommands(e,o=>u(o,a)),displayName:r,note:t};return{...e,...n}},exports.replaceSkillText=(e,a)=>{const r=c(e,a),t=m(e.name,a),n=m(e.description,a),o=m(e.message1,a),d=m(e.message2,a);return{...e,name:t,description:n,message1:o,message2:d,note:r}},exports.replaceStateText=(e,a)=>{const r=c(e,a),t=m(e.name,a),n=m(e.message1,a),o=m(e.message2,a),d=m(e.message3,a),p=m(e.message4,a);return{...e,name:t,message1:n,message2:o,message3:d,message4:p,note:r}},exports.replaceTextByMap=m,exports.replaceTroopTexts=(e,a)=>{const r=e.pages.map(t=>({list:u(t.list,a),conditions:t.conditions,span:t.span}));return{...e,pages:r}};
