"use strict";const o=require("./namedItems.cjs.js"),p=require("./mergeItemsSource.cjs.js"),S=e=>e.map(t=>t.parameters[0].trimEnd()).join(`
`).trimEnd();class E{constructor(t,r){this.header=t,this.bodies=r}getBodyText(){return S(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class x{constructor(t,r,a){this.bodyCode=t,this.header=r,this.bodies=a}normalizedCommands(){const t={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[t]:[t,this.mergedBody()]}getBodyText(){return S(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const i=(e,t,r,a)=>{const d=e[t];if(!r(d))throw new Error(`Invalid head at index ${t}: ${JSON.stringify(d)}`);const s=[];for(let n=t+1;n<e.length;n++){const l=e[n];if(!a(l))break;s.push(l)}return{header:d,bodies:s}},g=(e,t)=>{const{bodies:r,header:a}=((d,s)=>i(d,s,n=>n.code===o.COMMENT_HEAD,n=>n.code===o.COMMENT_BODY))(e,t);return I(a)?new x(o.COMMENT_BODY,a,r):new E(a,r)},I=e=>e.parameters[0]==="選択肢ヘルプ",C=(e,t)=>{const{bodies:r,header:a}=((d,s)=>i(d,s,n=>n.code===o.SHOW_MESSAGE,n=>n.code===o.SHOW_MESSAGE_BODY))(e,t);return new x(o.SHOW_MESSAGE_BODY,a,r)},y=(e,t)=>{const{bodies:r,header:a}=((d,s)=>i(d,s,o.isCommandScriptHeader,o.isCommandScriptBody))(e,t);return new E(a,r)},O=(e,t)=>{const{bodies:r,header:a}=((d,s)=>i(d,s,o.isCommandScrollTextHead,o.isCommandShowScrollingTextBody))(e,t);return new x(o.SHOW_SCROLLING_TEXT_BODY,a,r)},_={[o.SHOW_MESSAGE]:(e,t,r)=>r.showMessage(C(e,t),t,e),[o.SCRIPT_EVAL]:(e,t,r)=>r.script(y(e,t),t,e),[o.COMMENT_HEAD]:(e,t,r)=>r.comment(g(e,t),t,e),[o.SHOW_SCROLLING_TEXT]:(e,t,r)=>r.showScrollingText(O(e,t),t,e)},B=e=>((t,r)=>({code:t.code,paramIndex:r,value:t.parameters[r]}))(e,1),N=e=>e.parameters[0].map((t,r)=>({code:o.SHOW_CHOICES,paramIndex:r,value:t})),h=e=>e.reduce((t,r,a)=>{if(r.code===o.SHOW_CHOICES)return[...t,...N(r)];const d=(s=r.code,_[s]);var s;if(d){const n=d(e,a,f);if(n!==void 0)return[...t,n]}return r.code===o.CHANGE_NICKNAME||r.code===o.CHANGE_NAME||r.code===o.CHANGE_PROFILE?[...t,B(r)]:t},[]),f={comment:e=>{return{code:(t=e).header.code,paramIndex:0,value:t.getBodyText()};var t},showMessage:e=>{return t=e,{code:o.SHOW_MESSAGE_BODY,paramIndex:0,value:t.getBodyText(),speaker:(r=t.header,r.parameters[4]?r.parameters[4].trimEnd():"")};var t,r},script:e=>(t=>({code:o.SCRIPT_EVAL,paramIndex:0,value:t.getBodyText()}))(e),showScrollingText:e=>(t=>({code:o.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:t.getBodyText()}))(e)},v=e=>!!e,T=(e,t)=>e.pages.map((r,a)=>t(r,a,e)),b=(e,t)=>((r,a)=>r.events.filter(v).map(d=>T(d,a)))(e,t).flat(1),H=e=>b(e,(t,r,a)=>({eventId:a.id,pageIndex:r,commands:h(t.list),note:a.note,noteItems:[]})),c=(e,t,r)=>({folder:r,key:t,image:e[t],id:e.id}),m=(e,t)=>({note:u(e),main:t.map(r=>({key:r,text:e[r],id:e.id}))}),u=e=>o.readNoteEx(e.note,(t,r)=>({key:t,text:r,id:e.id}));exports.buildReferenceItemSources=(e,t,r,a,d,s)=>[...o.defineTraitItems(r,a),...o.defineGameDataSources(e,t),...o.defineSystemItems(d,s)],exports.compileItemEffectDisplayData=(e,t,r)=>{const a=o.resolveItemEffectLabels(t);return p.mergeItemsSource(r?[...a,...r]:a,e)},exports.compileTraitDisplayData=(e,t)=>p.mergeItemsSource(o.resolveTraitLabels(t),e),exports.expectBattleEventTexts=e=>((t,r)=>t.map(a=>T(a,r)))(e,(t,r,{id:a})=>({eventId:a,pageIndex:r,commands:h(t.list)})),exports.extractCommonEventTexts=e=>{return t=(r,a,{id:d})=>({eventId:d,commands:h(r.list)}),e.map(r=>t(r,0,r));var t},exports.extractImageFromActor=e=>[c(e,"faceName","faces"),c(e,"characterName","characters"),c(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractMapText=e=>({note:e.note,noteItems:o.readNote(e.note),displayedName:e.displayName,commands:H(e)}),exports.extractNoteText=u,exports.extractTextData=m,exports.extractTextFromActor=e=>m(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>m(e,["name","description"]),exports.extractTextFromClass=e=>m(e,["name"]),exports.extractTextFromEnemy=e=>m(e,["name"]),exports.extractTextFromItem=e=>m(e,["name","description"]),exports.extractTextFromSkill=e=>m(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>m(e,["name","message1","message2","message3","message4"]),exports.extractTextFromWeapon=e=>m(e,["name","description"]);
