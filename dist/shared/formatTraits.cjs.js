"use strict";const m=require("./make.cjs3.js"),N=require("./mergeItemsSource.cjs.js"),T=(e,a,s)=>e.reduce((o,t)=>(t.code!==m.CHANGE_ARMORS&&t.code!==m.CHANGE_ITEMS&&t.code!==m.CHANGE_WEAPONS||o.push(I(t,a,s)),o),[]),D={[m.CHANGE_WEAPONS]:"weapon",[m.CHANGE_ARMORS]:"armor",[m.CHANGE_ITEMS]:"item"},I=(e,a,s)=>{const o=e.parameters[3]===m.OPERAND_DIRECT?{direct:!0,value:e.parameters[2]}:{direct:!1,variableId:e.parameters[2]},t=e.parameters[0]===m.OPERATION_GAIN?a.gain:e.parameters[0]===m.OPERATION_LOSE?a.lose:a.unknown;return{itemKind:D[e.code],dataId:e.parameters[1],code:e.code,commandNameMZ:s(e.code),operation:t,includesEquip:e.parameters[4],...o}},H=e=>!!e,y=(e,a)=>e.pages.map((s,o)=>a(s,o,e)),C=(e,a)=>e.events.filter(H).flatMap(s=>y(s,a)),B=e=>e.conditions.itemId>0&&e.conditions.itemValid?{pageCondition:{itemId:e.conditions.itemId}}:{},r=(e,a)=>{const s=e.trimEnd(),o=a.get(s);return o!==void 0?o.trimEnd():s},S=(e,a,s=`
`)=>m.replaceNote(e.note,o=>r(o.value,a),s),p=(e,a)=>e.map(s=>{switch(s.code){case m.SHOW_MESSAGE:return A(s,a);case m.SHOW_CHOICES:return _(s,a);case m.SHOW_MESSAGE_BODY:case m.COMMENT_HEAD:case m.COMMENT_BODY:case m.SHOW_SCROLLING_TEXT_BODY:return v(s,a);case m.CHANGE_NAME:case m.CHANGE_NICKNAME:case m.CHANGE_PROFILE:return O(s,a);default:return s}}),v=(e,a)=>{const s=r(e.parameters[0],a);return{code:e.code,indent:e.indent,parameters:[s]}},A=(e,a)=>{const s=r(e.parameters[4],a);return m.makeCommandShowMessage({facename:e.parameters[0],faceIndex:e.parameters[1],background:e.parameters[2],positionType:e.parameters[3],speakerName:s},e.indent)},O=(e,a)=>{const s=r(e.parameters[1],a);return{code:e.code,indent:e.indent,parameters:[e.parameters[0],s]}},_=(e,a)=>{const s=e.parameters[0].map(o=>r(o,a));return{code:e.code,indent:e.indent,parameters:[s,e.parameters[1],e.parameters[2],e.parameters[3],e.parameters[4]]}},h=(e,a)=>({params:R(e.params,a),messages:w(e.messages,a),commands:F(e.commands,a),basic:G(e.basic,a)}),G=(e,a)=>[r(e[0],a),r(e[1],a),r(e[2],a),r(e[3],a),r(e[4],a),r(e[5],a),r(e[6],a),r(e[7],a),r(e[8],a),r(e[9],a)],F=(e,a)=>[r(e[0],a),r(e[1],a),r(e[2],a),r(e[3],a),r(e[4],a),r(e[5],a),r(e[6],a),r(e[7],a),r(e[8],a),r(e[9],a),r(e[10],a),r(e[11],a),r(e[12],a),r(e[13],a),r(e[14],a),r(e[15],a),r(e[16],a),r(e[17],a),r(e[18],a),r(e[19],a),"",r(e[21],a),r(e[22],a),"",r(e[24],a),r(e[25],a)],R=(e,a)=>[r(e[0],a),r(e[1],a),r(e[2],a),r(e[3],a),r(e[4],a),r(e[5],a),r(e[6],a),r(e[7],a),r(e[8],a),r(e[9],a)],w=(e,a)=>({actionFailure:r(e.actionFailure,a),actorDamage:r(e.actorDamage,a),actorDrain:r(e.actorDrain,a),actorGain:r(e.actorGain,a),actorLoss:r(e.actorLoss,a),actorNoDamage:r(e.actorNoDamage,a),actorNoHit:r(e.actorNoHit,a),actorRecovery:r(e.actorRecovery,a),alwaysDash:r(e.alwaysDash,a),autosave:r(e.autosave,a),bgmVolume:r(e.bgmVolume,a),bgsVolume:r(e.bgsVolume,a),buffAdd:r(e.buffAdd,a),buffRemove:r(e.buffRemove,a),commandRemember:r(e.commandRemember,a),counterAttack:r(e.counterAttack,a),criticalToActor:r(e.criticalToActor,a),criticalToEnemy:r(e.criticalToEnemy,a),defeat:r(e.defeat,a),debuffAdd:r(e.debuffAdd,a),emerge:r(e.emerge,a),enemyDamage:r(e.enemyDamage,a),enemyDrain:r(e.enemyDrain,a),enemyGain:r(e.enemyGain,a),enemyLoss:r(e.enemyLoss,a),enemyNoDamage:r(e.enemyNoDamage,a),enemyNoHit:r(e.enemyNoHit,a),enemyRecovery:r(e.enemyRecovery,a),escapeFailure:r(e.escapeFailure,a),escapeStart:r(e.escapeStart,a),evasion:r(e.evasion,a),expNext:r(e.expNext,a),expTotal:r(e.expTotal,a),file:r(e.file,a),loadMessage:r(e.loadMessage,a),levelUp:r(e.levelUp,a),magicEvasion:r(e.magicEvasion,a),magicReflection:r(e.magicReflection,a),meVolume:r(e.meVolume,a),obtainExp:r(e.obtainExp,a),obtainGold:r(e.obtainGold,a),obtainItem:r(e.obtainItem,a),obtainSkill:r(e.obtainSkill,a),partyName:r(e.partyName,a),possession:r(e.possession,a),preemptive:r(e.preemptive,a),saveMessage:r(e.saveMessage,a),seVolume:r(e.seVolume,a),substitute:r(e.substitute,a),surprise:r(e.surprise,a),touchUI:r(e.touchUI,a),useItem:r(e.useItem,a),victory:r(e.victory,a)}),d=(e,a)=>e.map(s=>r(s,a)),b=e=>e.map(a=>a.parameters[0].trimEnd()).join(`
`).trimEnd();class M{constructor(a,s){this.header=a,this.bodies=s}getBodyText(){return b(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class x{constructor(a,s,o){this.bodyCode=a,this.header=s,this.bodies=o}normalizedCommands(){const a={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[a]:[a,this.mergedBody()]}getBodyText(){return b(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const u=(e,a,s,o)=>{const t=e[a];if(!s(t))throw new Error(`Invalid head at index ${a}: ${JSON.stringify(t)}`);const n=[];for(let i=a+1;i<e.length;i++){const g=e[i];if(!o(g))break;n.push(g)}return{header:t,bodies:n}},k=(e,a)=>{const{bodies:s,header:o}=((t,n)=>u(t,n,i=>i.code===m.COMMENT_HEAD,i=>i.code===m.COMMENT_BODY))(e,a);return L(o)?new x(m.COMMENT_BODY,o,s):new M(o,s)},L=e=>e.parameters[0]==="選択肢ヘルプ",W=(e,a)=>{const{bodies:s,header:o}=((t,n)=>u(t,n,i=>i.code===m.SHOW_MESSAGE,i=>i.code===m.SHOW_MESSAGE_BODY))(e,a);return new x(m.SHOW_MESSAGE_BODY,o,s)},V=(e,a)=>{const{bodies:s,header:o}=((t,n)=>u(t,n,m.isCommandScriptHeader,m.isCommandScriptBody))(e,a);return new M(o,s)},P=(e,a)=>{const{bodies:s,header:o}=((t,n)=>u(t,n,m.isCommandScrollTextHead,m.isCommandShowScrollingTextBody))(e,a);return new x(m.SHOW_SCROLLING_TEXT_BODY,o,s)},Y={[m.SHOW_MESSAGE]:(e,a,s)=>s.showMessage(W(e,a),a,e),[m.SCRIPT_EVAL]:(e,a,s)=>s.script(V(e,a),a,e),[m.COMMENT_HEAD]:(e,a,s)=>s.comment(k(e,a),a,e),[m.SHOW_SCROLLING_TEXT]:(e,a,s)=>s.showScrollingText(P(e,a),a,e)},U=e=>((a,s)=>({code:a.code,paramIndex:s,value:a.parameters[s]}))(e,1),q=e=>e.parameters[0].map((a,s)=>({code:102,paramIndex:s,value:a})),l=e=>e.reduce((a,s,o)=>{if(s.code===m.SHOW_CHOICES)return[...a,...q(s)];const t=(n=s.code,Y[n]);var n;if(t){const i=t(e,o,j);if(i!==void 0)return[...a,i]}return s.code===m.CHANGE_NICKNAME||s.code===m.CHANGE_NAME||s.code===m.CHANGE_PROFILE?[...a,U(s)]:a},[]),j={comment:e=>{return a=e,{code:m.COMMENT_HEAD,paramIndex:0,value:a.getBodyText()};var a},showMessage:e=>{return a=e,{code:m.SHOW_MESSAGE_BODY,paramIndex:0,value:a.getBodyText(),speaker:(s=a.header,s.parameters[4]?s.parameters[4].trimEnd():"")};var a,s},script:e=>(a=>({code:m.SCRIPT_EVAL,paramIndex:0,value:a.getBodyText()}))(e),showScrollingText:e=>(a=>({code:m.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:a.getBodyText()}))(e)},X=e=>C(e,(a,s,o)=>({eventId:o.id,pageIndex:s,commands:l(a.list),note:o.note,noteItems:m.readNote(o.note),name:o.name})),E=(e,a,s)=>({folder:s,key:a,image:e[a],id:e.id}),c=(e,a)=>({note:f(e),main:a.map(s=>({key:s,text:e[s],id:e.id}))}),f=e=>m.readNoteEx(e.note,(a,s)=>({key:a,text:s,id:e.id}));exports.buildReferenceItemSources=(e,a,s,o,t,n)=>[...m.defineTraitItems(s,o),...m.defineGameDataSources(e,a),...m.defineSystemItems(t,n)],exports.compileItemEffectDisplayData=(e,a,s)=>{const o=m.resolveItemEffectLabels(a);return N.mergeItemsSource(s?[...o,...s]:o,e)},exports.compileTraitDisplayData=(e,a)=>N.mergeItemsSource(m.resolveTraitLabels(a),e),exports.extractBattleEventTexts=e=>((a,s)=>a.map(o=>y(o,s)))(e,(a,s,{id:o})=>({eventId:o,pageIndex:s,commands:l(a.list)})),exports.extractCommonEventTexts=e=>{return a=(s,o,{id:t})=>({eventId:t,commands:l(s.list)}),e.map(s=>a(s,0,s));var a},exports.extractImageFromActor=e=>[E(e,"faceName","faces"),E(e,"characterName","characters"),E(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractItemChangeData=I,exports.extractItemCommands=T,exports.extractItemFromMap=(e,a,s)=>C(e.map,(o,t,n)=>({...B(o),commands:T(o.list,a,s),eventName:n.name,pageIndex:t})),exports.extractItemFromTroop=(e,a,s)=>{return o=(t,n,i)=>({commands:T(t.list,a,s),eventName:i.name,troopId:i.id,pageIndex:n}),e.flatMap(t=>y(t,o));var o},exports.extractMapText=e=>({note:e.note,noteItems:m.readNote(e.note),displayedName:e.displayName,events:X(e)}),exports.extractNoteText=f,exports.extractTextData=c,exports.extractTextFromActor=e=>c(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>c(e,["name","description"]),exports.extractTextFromClass=e=>c(e,["name"]),exports.extractTextFromEnemy=e=>c(e,["name"]),exports.extractTextFromEventCommands=l,exports.extractTextFromItem=e=>c(e,["name","description"]),exports.extractTextFromSkill=e=>c(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>c(e,["name","message1","message2","message3","message4"]),exports.extractTextFromSystem=e=>({gameTitle:e.gameTitle,currencyUnit:e.currencyUnit,equipTypes:[...e.equipTypes],armorTypes:[...e.armorTypes],weaponTypes:[...e.weaponTypes],terms:{basic:m.makeTermsBasicFromArray(e.terms.basic),commands:m.makeTermsCommandFromArray(e.terms.commands),messages:m.makeTermsMessages(e.terms.messages),params:m.makeParamNamesFromArray(e.terms.params)}}),exports.extractTextFromWeapon=e=>c(e,["name","description"]),exports.replaceCommonEventTexts=(e,a)=>({...e,list:p(e.list,a)}),exports.replaceEventCommandTexts=p,exports.replaceMapDataTexts=(e,a)=>{const s=r(e.displayName,a),o=S(e,a),t={displayName:s,events:m.repleaceMapEventCommands(e,n=>p(n,a)),note:o};return{...e,...t}},exports.replaceNoteTextByMap=S,exports.replaceSystemTerms=h,exports.replaceSystemText=(e,a)=>({...e,gameTitle:r(e.gameTitle,a),currencyUnit:r(e.currencyUnit,a),elements:d(e.elements,a),skillTypes:d(e.skillTypes,a),weaponTypes:d(e.weaponTypes,a),armorTypes:d(e.armorTypes,a),equipTypes:d(e.equipTypes,a),terms:h(e.terms,a)}),exports.replaceTextByMap=r,exports.replaceTextForCommand=v,exports.replaceTextForCommandActor=O,exports.replaceTextForCommandShowChoices=_,exports.replaceTextForCommandShowMessage=A,exports.replaceTroopTexts=(e,a)=>{const s=e.pages.map(o=>({list:p(o.list,a),conditions:o.conditions,span:o.span}));return{...e,pages:s}};
