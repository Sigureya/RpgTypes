"use strict";const d=require("./namedItems.cjs.js"),S=require("./mergeItemsSource.cjs.js"),p=e=>e.map(t=>t.parameters[0].trimEnd()).join(`
`).trimEnd();class u{constructor(t,r){this.header=t,this.bodies=r}getBodyText(){return p(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class h{constructor(t,r,a){this.bodyCode=t,this.header=r,this.bodies=a}normalizedCommands(){const t={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[t]:[t,this.mergedBody()]}getBodyText(){return p(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const i=(e,t,r,a)=>{const o=e[t];if(!r(o))throw new Error(`Invalid head at index ${t}: ${JSON.stringify(o)}`);const s=[];for(let n=t+1;n<e.length;n++){const l=e[n];if(!a(l))break;s.push(l)}return{header:o,bodies:s}},I=(e,t)=>{const{bodies:r,header:a}=((o,s)=>i(o,s,n=>n.code===d.COMMENT_HEAD,n=>n.code===d.COMMENT_BODY))(e,t);return T(a)?new h(d.COMMENT_BODY,a,r):new u(a,r)},T=e=>e.parameters[0]==="選択肢ヘルプ",g=(e,t)=>{const{bodies:r,header:a}=((o,s)=>i(o,s,n=>n.code===d.SHOW_MESSAGE,n=>n.code===d.SHOW_MESSAGE_BODY))(e,t);return new h(d.SHOW_MESSAGE_BODY,a,r)},x=(e,t)=>{const{bodies:r,header:a}=((o,s)=>i(o,s,d.isCommandScriptHeader,d.isCommandScriptBody))(e,t);return new u(a,r)},C=(e,t)=>{const{bodies:r,header:a}=((o,s)=>i(o,s,d.isCommandScrollTextHead,d.isCommandShowScrollingTextBody))(e,t);return new h(d.SHOW_SCROLLING_TEXT_BODY,a,r)},O={[d.SHOW_MESSAGE]:(e,t,r)=>r.showMessage(g(e,t),t,e),[d.SCRIPT_EVAL]:(e,t,r)=>r.script(x(e,t),t,e),[d.COMMENT_HEAD]:(e,t,r)=>r.comment(I(e,t),t,e),[d.SHOW_SCROLLING_TEXT]:(e,t,r)=>r.showScrollingText(C(e,t),t,e)},_=e=>((t,r)=>({code:t.code,paramIndex:r,value:t.parameters[r]}))(e,1),y=e=>e.parameters[0].map((t,r)=>({code:d.SHOW_CHOICES,paramIndex:r,value:t})),c=e=>e.reduce((t,r,a)=>{if(r.code===d.SHOW_CHOICES)return[...t,...y(r)];const o=(s=r.code,O[s]);var s;if(o){const n=o(e,a,B);if(n!==void 0)return[...t,n]}return r.code===d.CHANGE_NICKNAME||r.code===d.CHANGE_NAME||r.code===d.CHANGE_PROFILE?[...t,_(r)]:t},[]),B={comment:e=>{return{code:(t=e).header.code,paramIndex:0,value:t.getBodyText()};var t},showMessage:e=>{return t=e,{code:d.SHOW_MESSAGE_BODY,paramIndex:0,value:t.getBodyText(),speaker:(r=t.header,r.parameters[4]?r.parameters[4].trimEnd():"")};var t,r},script:e=>(t=>({code:d.SCRIPT_EVAL,paramIndex:0,value:t.getBodyText()}))(e),showScrollingText:e=>(t=>({code:d.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:t.getBodyText()}))(e)},N=e=>!!e,E=(e,t)=>e.pages.map((r,a)=>t(r,a,e)),v=(e,t)=>((r,a)=>r.events.filter(N).map(o=>E(o,a)))(e,t).flat(1),b=e=>v(e,(t,r,a)=>({eventId:a.id,pageIndex:r,commands:c(t.list),note:a.note,noteItems:[]})),m=(e,t,r)=>({folder:r,key:t,image:e[t],id:e.id});exports.buildReferenceItemSources=(e,t,r,a,o,s)=>[...d.defineTraitItems(r,a),...d.defineGameDataSources(e,t),...d.defineSystemItems(o,s)],exports.compileItemEffectDisplayData=(e,t,r)=>{const a=d.resolveItemEffectLabels(t);return S.mergeItemsSource(r?[...a,...r]:a,e)},exports.compileTraitDisplayData=(e,t)=>S.mergeItemsSource(d.resolveTraitLabels(t),e),exports.expectBattleEventTexts=e=>((t,r)=>t.map(a=>E(a,r)))(e,(t,r,{id:a})=>({eventId:a,pageIndex:r,commands:c(t.list)})),exports.extractCommonEventTexts=e=>{return t=(r,a,{id:o})=>({eventId:o,commands:c(r.list)}),e.map(r=>t(r,0,r));var t},exports.extractImageFromActor=e=>[m(e,"faceName","faces"),m(e,"characterName","characters"),m(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractMapText=e=>({note:e.note,noteItems:d.readNote(e.note),displayedName:e.displayName,commands:b(e)});
