"use strict";const a=require("./make.cjs3.js"),h=require("./mergeItemsSource.cjs.js"),l=e=>e.map(t=>t.parameters[0].trimEnd()).join(`
`).trimEnd();class u{constructor(t,r){this.header=t,this.bodies=r}getBodyText(){return l(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class x{constructor(t,r,s){this.bodyCode=t,this.header=r,this.bodies=s}normalizedCommands(){const t={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[t]:[t,this.mergedBody()]}getBodyText(){return l(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const c=(e,t,r,s)=>{const o=e[t];if(!r(o))throw new Error(`Invalid head at index ${t}: ${JSON.stringify(o)}`);const m=[];for(let n=t+1;n<e.length;n++){const T=e[n];if(!s(T))break;m.push(T)}return{header:o,bodies:m}},g=(e,t)=>{const{bodies:r,header:s}=((o,m)=>c(o,m,n=>n.code===a.COMMENT_HEAD,n=>n.code===a.COMMENT_BODY))(e,t);return y(s)?new x(a.COMMENT_BODY,s,r):new u(s,r)},y=e=>e.parameters[0]==="選択肢ヘルプ",I=(e,t)=>{const{bodies:r,header:s}=((o,m)=>c(o,m,n=>n.code===a.SHOW_MESSAGE,n=>n.code===a.SHOW_MESSAGE_BODY))(e,t);return new x(a.SHOW_MESSAGE_BODY,s,r)},C=(e,t)=>{const{bodies:r,header:s}=((o,m)=>c(o,m,a.isCommandScriptHeader,a.isCommandScriptBody))(e,t);return new u(s,r)},_=(e,t)=>{const{bodies:r,header:s}=((o,m)=>c(o,m,a.isCommandScrollTextHead,a.isCommandShowScrollingTextBody))(e,t);return new x(a.SHOW_SCROLLING_TEXT_BODY,s,r)},O={[a.SHOW_MESSAGE]:(e,t,r)=>r.showMessage(I(e,t),t,e),[a.SCRIPT_EVAL]:(e,t,r)=>r.script(C(e,t),t,e),[a.COMMENT_HEAD]:(e,t,r)=>r.comment(g(e,t),t,e),[a.SHOW_SCROLLING_TEXT]:(e,t,r)=>r.showScrollingText(_(e,t),t,e)},B=e=>((t,r)=>({code:t.code,paramIndex:r,value:t.parameters[r]}))(e,1),N=e=>e.parameters[0].map((t,r)=>({code:102,paramIndex:r,value:t})),i=e=>e.reduce((t,r,s)=>{if(r.code===a.SHOW_CHOICES)return[...t,...N(r)];const o=(m=r.code,O[m]);var m;if(o){const n=o(e,s,v);if(n!==void 0)return[...t,n]}return r.code===a.CHANGE_NICKNAME||r.code===a.CHANGE_NAME||r.code===a.CHANGE_PROFILE?[...t,B(r)]:t},[]),v={comment:e=>{return t=e,{code:a.COMMENT_HEAD,paramIndex:0,value:t.getBodyText()};var t},showMessage:e=>{return t=e,{code:a.SHOW_MESSAGE_BODY,paramIndex:0,value:t.getBodyText(),speaker:(r=t.header,r.parameters[4]?r.parameters[4].trimEnd():"")};var t,r},script:e=>(t=>({code:a.SCRIPT_EVAL,paramIndex:0,value:t.getBodyText()}))(e),showScrollingText:e=>(t=>({code:a.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:t.getBodyText()}))(e)},b=e=>!!e,E=(e,t)=>e.pages.map((r,s)=>t(r,s,e)),f=(e,t)=>((r,s)=>r.events.filter(b).map(o=>E(o,s)))(e,t).flat(1),A=e=>f(e,(t,r,s)=>({eventId:s.id,pageIndex:r,commands:i(t.list),note:s.note,noteItems:[],name:s.name})),p=(e,t,r)=>({folder:r,key:t,image:e[t],id:e.id}),d=(e,t)=>({note:S(e),main:t.map(r=>({key:r,text:e[r],id:e.id}))}),S=e=>a.readNoteEx(e.note,(t,r)=>({key:t,text:r,id:e.id}));exports.buildReferenceItemSources=(e,t,r,s,o,m)=>[...a.defineTraitItems(r,s),...a.defineGameDataSources(e,t),...a.defineSystemItems(o,m)],exports.compileItemEffectDisplayData=(e,t,r)=>{const s=a.resolveItemEffectLabels(t);return h.mergeItemsSource(r?[...s,...r]:s,e)},exports.compileTraitDisplayData=(e,t)=>h.mergeItemsSource(a.resolveTraitLabels(t),e),exports.extractBattleEventTexts=e=>((t,r)=>t.map(s=>E(s,r)))(e,(t,r,{id:s})=>({eventId:s,pageIndex:r,commands:i(t.list)})),exports.extractCommonEventTexts=e=>{return t=(r,s,{id:o})=>({eventId:o,commands:i(r.list)}),e.map(r=>t(r,0,r));var t},exports.extractImageFromActor=e=>[p(e,"faceName","faces"),p(e,"characterName","characters"),p(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractMapText=e=>({note:e.note,noteItems:a.readNote(e.note),displayedName:e.displayName,events:A(e)}),exports.extractNoteText=S,exports.extractTextData=d,exports.extractTextFromActor=e=>d(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>d(e,["name","description"]),exports.extractTextFromClass=e=>d(e,["name"]),exports.extractTextFromEnemy=e=>d(e,["name"]),exports.extractTextFromEventCommands=i,exports.extractTextFromItem=e=>d(e,["name","description"]),exports.extractTextFromSkill=e=>d(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>d(e,["name","message1","message2","message3","message4"]),exports.extractTextFromSystem=e=>({gameTitle:e.gameTitle,currencyUnit:e.currencyUnit,equipTypes:[...e.equipTypes],armorTypes:[...e.armorTypes],weaponTypes:[...e.weaponTypes],terms:{basic:a.makeTermsBasicFromArray(e.terms.basic),commands:a.makeTermsCommandFromArray(e.terms.commands),messages:a.makeTermsMessages(e.terms.messages),params:a.makeParamNamesFromArray(e.terms.params)}}),exports.extractTextFromWeapon=e=>d(e,["name","description"]);
