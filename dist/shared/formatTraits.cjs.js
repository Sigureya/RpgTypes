"use strict";const s=require("./make.cjs3.js"),S=require("./mergeItemsSource.cjs.js"),d=(e,a)=>{const r=e.trimEnd(),t=a.get(r);return t!==void 0?t.trimEnd():r},p=(e,a)=>s.replaceNote(e.note,r=>d(r.value,a)),I=(e,a)=>{const r=d(e.parameters[0],a);return{code:e.code,indent:e.indent,parameters:[r]}},_=(e,a)=>{const r=d(e.parameters[4],a);return s.makeCommandShowMessage({facename:e.parameters[0],faceIndex:e.parameters[1],background:e.parameters[2],positionType:e.parameters[3],speakerName:r},e.indent)},O=(e,a)=>{const r=d(e.parameters[1],a);return{code:e.code,indent:e.indent,parameters:[e.parameters[0],r]}},M=(e,a)=>{const r=e.parameters[0].map(t=>d(t,a));return{code:e.code,indent:e.indent,parameters:[r,e.parameters[1],e.parameters[2],e.parameters[3],e.parameters[4]]}},g=e=>e.map(a=>a.parameters[0].trimEnd()).join(`
`).trimEnd();class y{constructor(a,r){this.header=a,this.bodies=r}getBodyText(){return g(this.joinCommandBodies())}mergedBody(){return{code:this.header.code,indent:this.header.indent,parameters:[this.getBodyText()]}}joinCommandBodies(){return[this.header,...this.bodies]}normalizedCommands(){return[this.mergedBody()]}}class h{constructor(a,r,t){this.bodyCode=a,this.header=r,this.bodies=t}normalizedCommands(){const a={...this.header,code:this.header.code,indent:this.header.indent,parameters:[...this.header.parameters]};return this.bodies.length===0?[a]:[a,this.mergedBody()]}getBodyText(){return g(this.bodies)}joinCommandBodies(){return this.bodies}mergedBody(){return{code:this.bodyCode,indent:this.header.indent,parameters:[this.getBodyText()]}}}const u=(e,a,r,t)=>{const n=e[a];if(!r(n))throw new Error(`Invalid head at index ${a}: ${JSON.stringify(n)}`);const o=[];for(let m=a+1;m<e.length;m++){const l=e[m];if(!t(l))break;o.push(l)}return{header:n,bodies:o}},A=(e,a)=>{const{bodies:r,header:t}=((n,o)=>u(n,o,m=>m.code===s.COMMENT_HEAD,m=>m.code===s.COMMENT_BODY))(e,a);return B(t)?new h(s.COMMENT_BODY,t,r):new y(t,r)},B=e=>e.parameters[0]==="選択肢ヘルプ",v=(e,a)=>{const{bodies:r,header:t}=((n,o)=>u(n,o,m=>m.code===s.SHOW_MESSAGE,m=>m.code===s.SHOW_MESSAGE_BODY))(e,a);return new h(s.SHOW_MESSAGE_BODY,t,r)},f=(e,a)=>{const{bodies:r,header:t}=((n,o)=>u(n,o,s.isCommandScriptHeader,s.isCommandScriptBody))(e,a);return new y(t,r)},H=(e,a)=>{const{bodies:r,header:t}=((n,o)=>u(n,o,s.isCommandScrollTextHead,s.isCommandShowScrollingTextBody))(e,a);return new h(s.SHOW_SCROLLING_TEXT_BODY,t,r)},b={[s.SHOW_MESSAGE]:(e,a,r)=>r.showMessage(v(e,a),a,e),[s.SCRIPT_EVAL]:(e,a,r)=>r.script(f(e,a),a,e),[s.COMMENT_HEAD]:(e,a,r)=>r.comment(A(e,a),a,e),[s.SHOW_SCROLLING_TEXT]:(e,a,r)=>r.showScrollingText(H(e,a),a,e)},D=e=>((a,r)=>({code:a.code,paramIndex:r,value:a.parameters[r]}))(e,1),k=e=>e.parameters[0].map((a,r)=>({code:102,paramIndex:r,value:a})),T=e=>e.reduce((a,r,t)=>{if(r.code===s.SHOW_CHOICES)return[...a,...k(r)];const n=(o=r.code,b[o]);var o;if(n){const m=n(e,t,F);if(m!==void 0)return[...a,m]}return r.code===s.CHANGE_NICKNAME||r.code===s.CHANGE_NAME||r.code===s.CHANGE_PROFILE?[...a,D(r)]:a},[]),F={comment:e=>{return a=e,{code:s.COMMENT_HEAD,paramIndex:0,value:a.getBodyText()};var a},showMessage:e=>{return a=e,{code:s.SHOW_MESSAGE_BODY,paramIndex:0,value:a.getBodyText(),speaker:(r=a.header,r.parameters[4]?r.parameters[4].trimEnd():"")};var a,r},script:e=>(a=>({code:s.SCRIPT_EVAL,paramIndex:0,value:a.getBodyText()}))(e),showScrollingText:e=>(a=>({code:s.SHOW_SCROLLING_TEXT_BODY,paramIndex:0,value:a.getBodyText()}))(e)},G=e=>!!e,C=(e,a)=>e.pages.map((r,t)=>a(r,t,e)),w=(e,a)=>((r,t)=>r.events.filter(G).map(n=>C(n,t)))(e,a).flat(1),W=e=>w(e,(a,r,t)=>({eventId:t.id,pageIndex:r,commands:T(a.list),note:t.note,noteItems:[],name:t.name})),E=(e,a,r)=>({folder:r,key:a,image:e[a],id:e.id}),i=(e,a)=>({note:N(e),main:a.map(r=>({key:r,text:e[r],id:e.id}))}),N=e=>s.readNoteEx(e.note,(a,r)=>({key:a,text:r,id:e.id}));exports.buildReferenceItemSources=(e,a,r,t,n,o)=>[...s.defineTraitItems(r,t),...s.defineGameDataSources(e,a),...s.defineSystemItems(n,o)],exports.compileItemEffectDisplayData=(e,a,r)=>{const t=s.resolveItemEffectLabels(a);return S.mergeItemsSource(r?[...t,...r]:t,e)},exports.compileTraitDisplayData=(e,a)=>S.mergeItemsSource(s.resolveTraitLabels(a),e),exports.extractBattleEventTexts=e=>((a,r)=>a.map(t=>C(t,r)))(e,(a,r,{id:t})=>({eventId:t,pageIndex:r,commands:T(a.list)})),exports.extractCommonEventTexts=e=>{return a=(r,t,{id:n})=>({eventId:n,commands:T(r.list)}),e.map(r=>a(r,0,r));var a},exports.extractImageFromActor=e=>[E(e,"faceName","faces"),E(e,"characterName","characters"),E(e,"battlerName","sv_actors")],exports.extractImageFromEnemy=e=>({key:"battlerName",image:e.battlerName,id:e.id}),exports.extractMapText=e=>({note:e.note,noteItems:s.readNote(e.note),displayedName:e.displayName,events:W(e)}),exports.extractNoteText=N,exports.extractTextData=i,exports.extractTextFromActor=e=>i(e,["name","nickname","profile"]),exports.extractTextFromArmor=e=>i(e,["name","description"]),exports.extractTextFromClass=e=>i(e,["name"]),exports.extractTextFromEnemy=e=>i(e,["name"]),exports.extractTextFromEventCommands=T,exports.extractTextFromItem=e=>i(e,["name","description"]),exports.extractTextFromSkill=e=>i(e,["name","description","message1","message2"]),exports.extractTextFromState=e=>i(e,["name","message1","message2","message3","message4"]),exports.extractTextFromSystem=e=>({gameTitle:e.gameTitle,currencyUnit:e.currencyUnit,equipTypes:[...e.equipTypes],armorTypes:[...e.armorTypes],weaponTypes:[...e.weaponTypes],terms:{basic:s.makeTermsBasicFromArray(e.terms.basic),commands:s.makeTermsCommandFromArray(e.terms.commands),messages:s.makeTermsMessages(e.terms.messages),params:s.makeParamNamesFromArray(e.terms.params)}}),exports.extractTextFromWeapon=e=>i(e,["name","description"]),exports.replaceActorText=(e,a)=>{const r=p(e,a),t=d(e.name,a),n=d(e.nickname,a),o=d(e.profile,a);return{...e,name:t,nickname:n,profile:o,note:r}},exports.replaceClassText=(e,a)=>{const r=p(e,a),t=d(e.name,a);return{...e,name:t,note:r}},exports.replaceEnemyText=(e,a)=>{const r=p(e,a),t=d(e.name,a);return{...e,name:t,note:r}},exports.replaceItemText=(e,a)=>{const r=p(e,a),t=d(e.name,a),n=d(e.description,a);return{...e,name:t,description:n,note:r}},exports.replaceMapTexts=(e,a)=>{const r=d(e.displayName,a),t=s.replaceNote(e.note,m=>d(m.value,a)),n=s.repleaceEventCommands(e,m=>((l,x)=>l.map(c=>{switch(c.code){case s.SHOW_MESSAGE:return _(c,x);case s.SHOW_CHOICES:return M(c,x);case s.SHOW_MESSAGE_BODY:case s.COMMENT_HEAD:case s.COMMENT_BODY:return I(c,x);case s.CHANGE_NAME:case s.CHANGE_NICKNAME:case s.CHANGE_PROFILE:return O(c,x);default:return c}}))(m,a));return{...e,...{events:n,displayName:r,note:t}}},exports.replaceSkillText=(e,a)=>{const r=p(e,a),t=d(e.name,a),n=d(e.description,a),o=d(e.message1,a),m=d(e.message2,a);return{...e,name:t,description:n,message1:o,message2:m,note:r}},exports.replaceTextByMap=d;
