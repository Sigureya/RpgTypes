"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const L=require("../shared/lookupRpgDataKind.cjs.js"),P=r=>r.kind.endsWith("[]"),W=r=>r.kind!=="struct"&&!P(r),v=r=>r.kind==="struct",D=r=>v(r.attr)||C(r.attr),C=r=>r.kind==="struct[]",V=r=>W(r)&&J(r),J=r=>g[r.kind].type==="number",I=r=>g[r.kind.replace("[]","")].type==="number",y={type:"string",hasText:!0},u={type:"number",hasText:!1},m={type:"number",hasText:!1},g={string:y,number:{type:"number",hasText:!1},boolean:{type:"boolean"},armor:u,actor:u,class:u,enemy:u,skill:u,state:u,item:u,weapon:u,common_event:u,switch:u,variable:u,troop:u,multiline_string:y,file:{type:"string",hasText:!1},"file[]":{type:"string",hasText:!1},"multiline_string[]":y,"string[]":y,combo:y,select:y,any:y,struct:{type:"struct"},"actor[]":m,"enemy[]":m,"class[]":m,"skill[]":m,"state[]":m,"item[]":m,"weapon[]":m,"common_event[]":m,"troop[]":m,"armor[]":m,"switch[]":m,"variable[]":m,"number[]":m},R=(r,e,t)=>{const n=e.get(r);return n?n.filter(c=>((a,o)=>!(!v(a)&&!C(a)||!a.struct||o.has(a.struct)))(c,t)).flatMap(c=>{const a=c.struct;return t.add(a),[a,...R(a,e,t)]}):[]},Z=(r,e)=>Object.entries(e).reduce((t,[n,c])=>{if(n in r){const a=r[n];if(typeof a=="string")return{...t,[n]:c(a)}}return t},{}),f=(r,e,t,n)=>({default:e,...Z(t,n),kind:r}),A=(r,e,t)=>({default:[],...Z(e,t),kind:r}),$="BODY",q="STRUCT",k="NONE",er=(r,e)=>{const t=r.lines.length>0?E(r):r,n=e[1]||void 0;return{...t,structName:n,blockType:n?q:"INVALID",locale:e[2],lines:[]}},tr=r=>({...r.lines.length>0?E(r):r,blockType:$,structName:void 0,locale:void 0,lines:[]}),E=r=>r.blockType===$?{...r,bodies:r.bodies.concat([{lines:[...r.lines]}]),lines:[],blockType:k}:r.structName&&r.blockType===q?{...r,structs:r.structs.concat([{struct:r.structName,locale:r.locale,lines:[...r.lines]}]),blockType:k,structName:void 0,locale:void 0,lines:[]}:{...r,blockType:k,structName:void 0,lines:[]},nr=r=>r.currentOption?{items:r.items.concat({option:r.currentOption,value:r.currentOption})}:r,H="help",j="kind",S="text",M="struct",U=r=>{const e=JSON.parse(r);return Array.isArray(e)?e.map(T):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,T(n)])):e},T=r=>{if(typeof r!="string")return r;try{const e=JSON.parse(r);return Array.isArray(e)?e.map(T):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,T(n)])):e}catch{return r}},Y=r=>{if(j in r.attr){const e=ar[r.attr.kind];if(e)return e(r)}return f("any","",r.attr,N)},s=r=>r,G=r=>r.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),N={default:s,text:s,desc:s,parent:s},z=r=>f("string","",r.attr,N),K=r=>{const e={default:t=>U(t),text:s,desc:s,parent:s};return A("string[]",r.attr,e)},l=(r,e)=>{const t={default:G,text:s,desc:s,parent:s};return A(e,r.attr,t)},d=(r,e)=>{const t={default:n=>parseInt(n,10),text:s,desc:s,parent:s};return f(e,0,r.attr,t)},ar={number:r=>(e=>{const t={default:n=>parseFloat(n),text:s,desc:s,decimals:n=>parseInt(n,10),min:n=>parseFloat(n),max:n=>parseFloat(n),parent:s};return f("number",0,e.attr,t)})(r),"number[]":r=>{const e={default:G,text:s,desc:s,decimals:t=>parseInt(t,10),min:t=>parseFloat(t),max:t=>parseFloat(t),parent:s};return A("number[]",r.attr,e)},string:z,"string[]":K,multiline_string:z,"multiline_string[]":K,combo:r=>{var t;const e=((t=r.options)==null?void 0:t.map(n=>n.option))??[];return{...f("combo","",r.attr,N),options:e}},select:r=>{var t;const e=((t=r.options)==null?void 0:t.map(n=>({option:n.option,value:n.value})))??[];return{...f("select","",r.attr,N),options:e}},actor:r=>d(r,"actor"),"actor[]":r=>l(r,"actor[]"),class:r=>d(r,"class"),"class[]":r=>l(r,"class[]"),skill:r=>d(r,"skill"),"skill[]":r=>l(r,"skill[]"),item:r=>d(r,"item"),"item[]":r=>l(r,"item[]"),weapon:r=>d(r,"weapon"),"weapon[]":r=>l(r,"weapon[]"),armor:r=>d(r,"armor"),"armor[]":r=>l(r,"armor[]"),state:r=>d(r,"state"),"state[]":r=>l(r,"state[]"),enemy:r=>d(r,"enemy"),"enemy[]":r=>l(r,"enemy[]"),common_event:r=>d(r,"common_event"),"common_event[]":r=>l(r,"common_event[]"),switch:r=>d(r,"switch"),"switch[]":r=>l(r,"switch[]"),variable:r=>d(r,"variable"),"variable[]":r=>l(r,"variable[]"),troop:r=>d(r,"troop"),"troop[]":r=>l(r,"troop[]"),boolean:r=>{const e={default:t=>t==="true",text:s,desc:s,on:s,off:s,parent:s};return f("boolean",!0,r.attr,e)},file:r=>{const e={default:s,text:s,desc:s,parent:s,dir:s};return{dir:"",...f("file","",r.attr,e)}},"file[]":r=>{const e={default:t=>U(t),text:s,desc:s,parent:s,dir:s};return{dir:"",...A("file[]",r.attr,e)}}},_=r=>({...typeof r.desc=="string"?{desc:r.desc}:{},...typeof r.text=="string"?{text:r.text}:{}}),O=r=>{const e=sr(r),t=or(e);return cr(t)},sr=r=>{if(r.currentParam&&r.currentOption){const e=r.currentParam.attr.kind;if(e==="select"||e==="combo")return{...r,currentParam:{...r.currentParam,options:nr(r.currentOption).items}}}return r},cr=r=>r.currentParam?{...r,params:[...r.params,r.currentParam],currentParam:null,currentContext:null}:r,or=r=>{if(!r.currentCommand)return r;const e=r.currentParam?[...r.currentCommand.args,r.currentParam]:r.currentCommand.args,t={..._(r.currentCommand),command:r.currentCommand.command,args:e};return{...r,commands:[...r.commands,t],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},mr=r=>{const e=(a=>{const o=a.split(`
`),h={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:k},b=o.reduce((i,rr)=>{const x=rr.trim(),F=x.match(/^\/\*~struct~([A-Za-z0-9_]+)(?::([A-Za-z0-9_-]+))?/);return F?er(i,F):x==="/*:"?tr(i):x==="*/"?i.lines.length>0?E(i):i:{...i,lines:i.lines.concat([x])}},h);return{structs:b.structs,bodies:b.bodies}})(r),t=e.structs.map(a=>ir(a)),n=ur(e);if(!n)return{params:[],commands:[],meta:{},helpLines:[],structs:t};const c=Q(n,X);return{params:c.params,commands:c.commands,meta:c.meta,helpLines:c.helpLines,structs:t}},ir=r=>{const e=Q(r,X);return{name:r.struct,params:e.params}},ur=r=>{if(r.bodies.length!==0)return r.bodies[0]},Q=(r,e)=>{const t=r.lines.reduce((n,c)=>{const a=c.trimEnd().replace(/^[\*\s]*/,"");if(!a.startsWith("@"))return n.currentContext===H?{...n,helpLines:n.helpLines.concat(a)}:n;const o=a.match(/^@(\S+)\s*(.*)$/);if(!o)return n;const[,h,b]=o,i=e[h];return i?i(n,b.trim()):n},lr());return O(t)},lr=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),p=(r,e,t)=>r.currentParam&&!(e in r.currentParam.attr)?{...r,currentParam:{...r.currentParam,attr:{...r.currentParam.attr,[e]:t}}}:r,w=(r,e,t)=>({...r,meta:{[e]:t,...r.meta}}),X={param:(r,e)=>{const t=O(r);return t.params.some(n=>n.name===e)?t:{...t,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(r,e)=>r.currentParam?p(r,S,e):r.currentCommand&&!(S in r.currentCommand)?{...r,currentCommand:{..._(r.currentCommand),command:r.currentCommand.command,args:r.currentCommand.args,[S]:e}}:r,desc:(r,e)=>r.currentParam?p(r,"desc",e):r.currentCommand?{...r,currentCommand:{...r.currentCommand,desc:e}}:r,command:(r,e)=>{const t=O(r);return t.commands.some(n=>n.command===e)?t:{...t,currentCommand:{command:e,args:[]},currentParam:null}},arg:(r,e)=>{if(!r.currentCommand)return r;if(!r.currentParam)return{...r,currentParam:{name:e,attr:{}}};const t={..._(r.currentCommand),command:r.currentCommand.command,args:r.currentCommand.args.concat(r.currentParam)};return{...r,commands:r.commands,currentCommand:t,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:r=>({...O(r),currentContext:H}),option:(r,e)=>{if(!r.currentParam)return r;const t=((n,c)=>n.currentOption?{items:n.items.concat({option:n.currentOption,value:n.currentOption}),currentOption:c}:{items:n.items,currentOption:c})(r.currentOption??{items:[]},e);return{...r,currentOption:t}},value:(r,e)=>{if(!r.currentOption)return r;const t=((n,c)=>n.currentOption?{items:n.items.concat({option:n.currentOption,value:c})}:{items:n.items})(r.currentOption,e);return{...r,currentOption:t}},type:(r,e)=>{if((t=>t.endsWith(">")&&t.startsWith("struct<"))(e)){const t=e.slice(7,-1),n=p(r,M,t);return p(n,j,M)}return r.currentParam?p(r,j,e):r},default:(r,e)=>p(r,"default",e),on:(r,e)=>p(r,"on",e),off:(r,e)=>p(r,"off",e),min:(r,e)=>p(r,"min",e),max:(r,e)=>p(r,"max",e),base:(r,e)=>{return{...r,dependencies:(t=r.dependencies,n=e,{orderAfter:t.orderAfter,orderBefore:t.orderBefore,base:t.base.concat(n)})};var t,n},orderAfter:(r,e)=>{return{...r,dependencies:(t=r.dependencies,n=e,{base:t.base,orderBefore:t.orderBefore,orderAfter:t.orderAfter.concat(n)})};var t,n},orderBefore:(r,e)=>{return{...r,dependencies:(t=r.dependencies,n=e,{base:t.base,orderAfter:t.orderAfter,orderBefore:t.orderBefore.concat(n)})};var t,n},author:(r,e)=>w(r,"author",e),plugindesc:(r,e)=>w(r,"plugindesc",e),url:(r,e)=>w(r,"url",e)},dr=r=>({target:"MZ",meta:r.meta,commands:pr(r.commands),params:B(r.params),structs:fr(r.structs)}),B=r=>Object.fromEntries(r.map(e=>[e.name,Y(e)])),pr=r=>Object.fromEntries(r.map(e=>[e.command,{desc:e.desc,text:e.text,args:B(e.args)}])),fr=r=>Object.fromEntries(r.map(e=>[e.name,{params:B(e.params)}]));exports.isRmmzDataKind=L.isRmmzDataKind,exports.lookupKind=L.lookupKind,exports.classifyPluginParams=r=>{const e=[],t=[],n=[],c=[];return r.params.forEach(a=>{v(a.attr)?e.push({name:a.name,attr:a.attr}):C(a.attr)?t.push({name:a.name,attr:a.attr}):P(a.attr)?c.push({name:a.name,attr:a.attr}):n.push({name:a.name,attr:a.attr})}),{structs:e,structArrays:t,scalas:n,scalaArrays:c}},exports.collectDependentStructNames=(r,e)=>{const t=function(n){return Object.fromEntries(n.map(c=>[c.struct,c.params.filter(D)]))}(r);return function(n,c,a){return n.reduce(o=>{if(!o.changed)return o;const h=n.filter(b=>!o.names.has(b)&&c[b].some(i=>o.names.has(i.attr.struct)));return h.length===0?{names:o.names,changed:!1}:{names:new Set([...o.names,...h]),changed:!0}},{names:a,changed:!0}).names}(Object.keys(t),t,new Set(e))},exports.compileAttributes=Y,exports.createStructMap=r=>new Map(r.map(e=>[e.struct,e.params.map(t=>t.attr)])),exports.hasNumberValueParam=r=>P(r)?I(r):V(r),exports.hasTextAttr=r=>{var e;return((e=g[r.attr.kind])==null?void 0:e.hasText)===!0},exports.isArrayParam=P,exports.isArrayParamEx=(r,e)=>!!P(r)&&r.kind===`${e}[]`,exports.isFileAttr=r=>r.attr.kind==="file"||r.attr.kind==="file[]",exports.isNumberArrayParam=I,exports.isNumberAttr=r=>{var e;return((e=g[r.attr.kind])==null?void 0:e.type)==="number"},exports.isNumberValueParam=V,exports.isNumberValueParamEx=J,exports.isScalarParam=W,exports.isStringArrayParam=r=>g[r.kind.replace("[]","")].type==="string",exports.isStringValueParam=r=>g[r.kind].type==="string",exports.isStructArrayParam=C,exports.isStructAttr=D,exports.isStructParam=v,exports.isVariableAttr=r=>r.attr.kind==="variable"||r.attr.kind==="variable[]",exports.paramHasText=r=>{var e;return((e=g[r.kind])==null?void 0:e.hasText)===!0},exports.pluginSourceToJSON=r=>(e=>dr(mr(e)))(r),exports.structDependencies=(r,e)=>R(r,e,new Set);
