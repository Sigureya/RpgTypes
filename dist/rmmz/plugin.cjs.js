"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const pr=require("../shared/textAndDesc.cjs.js"),K=require("../shared/lookupRpgDataKind.cjs.js"),x=r=>r.kind.endsWith("[]"),Y=r=>x(r.attr),G=r=>r.kind!=="struct"&&!x(r),N=r=>r.kind==="struct",D=r=>N(r.attr)||L(r.attr),L=r=>r.kind==="struct[]",Q=r=>r.attr.kind==="struct[]",O=r=>{var e;return((e=y[r.attr.kind])==null?void 0:e.hasText)===!0},W=r=>G(r)&&X(r),X=r=>y[r.kind].type==="number",J=r=>y[r.kind.replace("[]","")].type==="number",R=r=>{var e;return((e=y[r.attr.kind])==null?void 0:e.type)==="number"},Z=r=>r.attr.kind==="variable"||r.attr.kind==="variable[]",q=r=>r.attr.kind==="file"||r.attr.kind==="file[]",h={type:"string",hasText:!0},l={type:"number",hasText:!1},i={type:"number",hasText:!1},y={string:h,number:{type:"number",hasText:!1},boolean:{type:"boolean"},armor:l,actor:l,class:l,enemy:l,skill:l,state:l,item:l,weapon:l,common_event:l,switch:l,variable:l,troop:l,multiline_string:h,file:{type:"string",hasText:!1},"file[]":{type:"string",hasText:!1},"multiline_string[]":h,"string[]":h,combo:h,select:h,any:h,struct:{type:"struct"},"actor[]":i,"enemy[]":i,"class[]":i,"skill[]":i,"state[]":i,"item[]":i,"weapon[]":i,"common_event[]":i,"troop[]":i,"armor[]":i,"switch[]":i,"variable[]":i,"number[]":i},rr=(r,e)=>{const t=function(n){return Object.fromEntries(n.map(a=>[a.struct,a.params.filter(D)]))}(r);return function(n,a,s){return n.reduce(m=>{if(!m.changed)return m;const o=n.filter(g=>!m.names.has(g)&&a[g].some(u=>m.names.has(u.attr.struct)));return o.length===0?{names:m.names,changed:!1}:{names:new Set([...m.names,...o]),changed:!0}},{names:s,changed:!0}).names}(Object.keys(t),t,new Set(e))},P=(r,e)=>{const t=r.structs.filter(s=>s.params.some(m=>e(m))),n=new Set(t.map(s=>s.struct)),a=rr(r.structs,n);return{structs:fr(r.structs,a,e),commands:er(r.commands,a,e),params:V(r.params,a,e)}},V=(r,e,t)=>r.filter(n=>D(n)?e.has(n.attr.struct):t(n)),fr=(r,e,t)=>r.reduce((n,a)=>{const s=V(a.params,e,t);return s.length===0||n.push({struct:a.struct,params:s}),n},[]),er=(r,e,t)=>r.reduce((n,a)=>{const s=V(a.args,e,t);return s.length===0||n.push({...a.desc?{desc:a.desc}:{},...a.text?{text:a.text}:{},command:a.command,args:s}),n},[]),w=(r,e,t)=>{const n=[],a=[],s=[],m=[];return r.forEach(o=>{if(N(o.attr))n.push({name:o.name,attr:o.attr});else if(Q(o))a.push(o);else if(Y(o)){if(t(o))return void m.push(o)}else e(o)&&s.push(o)}),{structs:n,structArrays:a,scalas:s,scalaArrays:m}};function j(r){const e=r.map(t=>[t.name,t.attr]);return Object.fromEntries(e)}const tr=(r,e,t)=>{const n=e.get(r);return n?n.filter(a=>((s,m)=>!(!N(s)&&!L(s)||!s.struct||m.has(s.struct)))(a,t)).flatMap(a=>{const s=a.struct;return t.add(s),[s,...tr(s,e,t)]}):[]},nr=(r,e)=>Object.entries(e).reduce((t,[n,a])=>{if(n in r){const s=r[n];if(typeof s=="string")return{...t,[n]:a(s)}}return t},{}),b=(r,e,t,n)=>({default:e,...nr(t,n),kind:r}),C=(r,e,t)=>({default:[],...nr(e,t),kind:r}),ar="BODY",sr="STRUCT",v="NONE",br=(r,e)=>{const t=r.lines.length>0?I(r):r,n=e[1]||void 0;return{...t,structName:n,blockType:n?sr:"INVALID",locale:e[2],lines:[]}},gr=r=>({...r.lines.length>0?I(r):r,blockType:ar,structName:void 0,locale:void 0,lines:[]}),I=r=>r.blockType===ar?{...r,bodies:r.bodies.concat([{lines:[...r.lines]}]),lines:[],blockType:v}:r.structName&&r.blockType===sr?{...r,structs:r.structs.concat([{struct:r.structName,locale:r.locale,lines:[...r.lines]}]),blockType:v,structName:void 0,locale:void 0,lines:[]}:{...r,blockType:v,structName:void 0,lines:[]},hr=r=>r.currentOption?{items:r.items.concat({option:r.currentOption,value:r.currentOption})}:r,cr="help",_="kind",B="text",$="struct",mr=r=>{const e=JSON.parse(r);return Array.isArray(e)?e.map(S):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,S(n)])):e},S=r=>{if(typeof r!="string")return r;try{const e=JSON.parse(r);return Array.isArray(e)?e.map(S):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,S(n)])):e}catch{return r}},or=r=>{if(_ in r.attr){const e=yr[r.attr.kind];if(e)return e(r)}return b("any","",r.attr,T)},c=r=>r,ir=r=>r.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),T={default:c,text:c,desc:c,parent:c},H=r=>b("string","",r.attr,T),U=r=>{const e={default:t=>mr(t),text:c,desc:c,parent:c};return C("string[]",r.attr,e)},d=(r,e)=>{const t={default:ir,text:c,desc:c,parent:c};return C(e,r.attr,t)},p=(r,e)=>{const t={default:n=>parseInt(n,10),text:c,desc:c,parent:c};return b(e,0,r.attr,t)},yr={number:r=>(e=>{const t={default:n=>parseFloat(n),text:c,desc:c,decimals:n=>parseInt(n,10),min:n=>parseFloat(n),max:n=>parseFloat(n),parent:c};return b("number",0,e.attr,t)})(r),"number[]":r=>{const e={default:ir,text:c,desc:c,decimals:t=>parseInt(t,10),min:t=>parseFloat(t),max:t=>parseFloat(t),parent:c};return C("number[]",r.attr,e)},string:H,"string[]":U,multiline_string:H,"multiline_string[]":U,combo:r=>{var t;const e=((t=r.options)==null?void 0:t.map(n=>n.option))??[];return{...b("combo","",r.attr,T),options:e}},select:r=>{var t;const e=((t=r.options)==null?void 0:t.map(n=>({option:n.option,value:n.value})))??[];return{...b("select","",r.attr,T),options:e}},actor:r=>p(r,"actor"),"actor[]":r=>d(r,"actor[]"),class:r=>p(r,"class"),"class[]":r=>d(r,"class[]"),skill:r=>p(r,"skill"),"skill[]":r=>d(r,"skill[]"),item:r=>p(r,"item"),"item[]":r=>d(r,"item[]"),weapon:r=>p(r,"weapon"),"weapon[]":r=>d(r,"weapon[]"),armor:r=>p(r,"armor"),"armor[]":r=>d(r,"armor[]"),state:r=>p(r,"state"),"state[]":r=>d(r,"state[]"),enemy:r=>p(r,"enemy"),"enemy[]":r=>d(r,"enemy[]"),common_event:r=>p(r,"common_event"),"common_event[]":r=>d(r,"common_event[]"),switch:r=>p(r,"switch"),"switch[]":r=>d(r,"switch[]"),variable:r=>p(r,"variable"),"variable[]":r=>d(r,"variable[]"),troop:r=>p(r,"troop"),"troop[]":r=>d(r,"troop[]"),boolean:r=>{const e={default:t=>t==="true",text:c,desc:c,on:c,off:c,parent:c};return b("boolean",!0,r.attr,e)},file:r=>{const e={default:c,text:c,desc:c,parent:c,dir:c};return{dir:"",...b("file","",r.attr,e)}},"file[]":r=>{const e={default:t=>mr(t),text:c,desc:c,parent:c,dir:c};return{dir:"",...C("file[]",r.attr,e)}}},F=r=>({...typeof r.desc=="string"?{desc:r.desc}:{},...typeof r.text=="string"?{text:r.text}:{}}),A=r=>{const e=Pr(r),t=kr(e);return xr(t)},Pr=r=>{if(r.currentParam&&r.currentOption){const e=r.currentParam.attr.kind;if(e==="select"||e==="combo")return{...r,currentParam:{...r.currentParam,options:hr(r.currentOption).items}}}return r},xr=r=>r.currentParam?{...r,params:[...r.params,r.currentParam],currentParam:null,currentContext:null}:r,kr=r=>{if(!r.currentCommand)return r;const e=r.currentParam?[...r.currentCommand.args,r.currentParam]:r.currentCommand.args,t={...F(r.currentCommand),command:r.currentCommand.command,args:e};return{...r,commands:[...r.commands,t],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},Or=r=>{const e=(s=>{const m=s.split(`
`),o={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:v},g=m.reduce((u,dr)=>{const k=dr.trim(),z=k.match(/^\/\*~struct~([A-Za-z0-9_]+)(?::([A-Za-z0-9_-]+))?/);return z?br(u,z):k==="/*:"?gr(u):k==="*/"?u.lines.length>0?I(u):u:{...u,lines:u.lines.concat([k])}},o);return{structs:g.structs,bodies:g.bodies}})(r),t=e.structs.map(s=>vr(s)),n=Ar(e);if(!n)return{params:[],commands:[],meta:{},helpLines:[],structs:t};const a=ur(n,lr);return{params:a.params,commands:a.commands,meta:a.meta,helpLines:a.helpLines,structs:t}},vr=r=>{const e=ur(r,lr);return{name:r.struct,params:e.params}},Ar=r=>{if(r.bodies.length!==0)return r.bodies[0]},ur=(r,e)=>{const t=r.lines.reduce((n,a)=>{const s=a.trimEnd().replace(/^[\*\s]*/,"");if(!s.startsWith("@"))return n.currentContext===cr?{...n,helpLines:n.helpLines.concat(s)}:n;const m=s.match(/^@(\S+)\s*(.*)$/);if(!m)return n;const[,o,g]=m,u=e[o];return u?u(n,g.trim()):n},Cr());return A(t)},Cr=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),f=(r,e,t)=>r.currentParam&&!(e in r.currentParam.attr)?{...r,currentParam:{...r.currentParam,attr:{...r.currentParam.attr,[e]:t}}}:r,E=(r,e,t)=>({...r,meta:{[e]:t,...r.meta}}),lr={param:(r,e)=>{const t=A(r);return t.params.some(n=>n.name===e)?t:{...t,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(r,e)=>r.currentParam?f(r,B,e):r.currentCommand&&!(B in r.currentCommand)?{...r,currentCommand:{...F(r.currentCommand),command:r.currentCommand.command,args:r.currentCommand.args,[B]:e}}:r,desc:(r,e)=>r.currentParam?f(r,"desc",e):r.currentCommand?{...r,currentCommand:{...r.currentCommand,desc:e}}:r,command:(r,e)=>{const t=A(r);return t.commands.some(n=>n.command===e)?t:{...t,currentCommand:{command:e,args:[]},currentParam:null}},arg:(r,e)=>{if(!r.currentCommand)return r;if(!r.currentParam)return{...r,currentParam:{name:e,attr:{}}};const t={...F(r.currentCommand),command:r.currentCommand.command,args:r.currentCommand.args.concat(r.currentParam)};return{...r,commands:r.commands,currentCommand:t,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:r=>({...A(r),currentContext:cr}),option:(r,e)=>{if(!r.currentParam)return r;const t=((n,a)=>n.currentOption?{items:n.items.concat({option:n.currentOption,value:n.currentOption}),currentOption:a}:{items:n.items,currentOption:a})(r.currentOption??{items:[]},e);return{...r,currentOption:t}},value:(r,e)=>{if(!r.currentOption)return r;const t=((n,a)=>n.currentOption?{items:n.items.concat({option:n.currentOption,value:a})}:{items:n.items})(r.currentOption,e);return{...r,currentOption:t}},type:(r,e)=>{if((t=>t.endsWith(">")&&t.startsWith("struct<"))(e)){const t=e.slice(7,-1),n=f(r,$,t);return f(n,_,$)}return r.currentParam?f(r,_,e):r},default:(r,e)=>f(r,"default",e),on:(r,e)=>f(r,"on",e),off:(r,e)=>f(r,"off",e),min:(r,e)=>f(r,"min",e),max:(r,e)=>f(r,"max",e),base:(r,e)=>{return{...r,dependencies:(t=r.dependencies,n=e,{orderAfter:t.orderAfter,orderBefore:t.orderBefore,base:t.base.concat(n)})};var t,n},orderAfter:(r,e)=>{return{...r,dependencies:(t=r.dependencies,n=e,{base:t.base,orderBefore:t.orderBefore,orderAfter:t.orderAfter.concat(n)})};var t,n},orderBefore:(r,e)=>{return{...r,dependencies:(t=r.dependencies,n=e,{base:t.base,orderAfter:t.orderAfter,orderBefore:t.orderBefore.concat(n)})};var t,n},author:(r,e)=>E(r,"author",e),plugindesc:(r,e)=>E(r,"plugindesc",e),url:(r,e)=>E(r,"url",e)},Sr=r=>({target:"MZ",meta:r.meta,commands:Tr(r.commands),params:M(r.params),structs:Nr(r.structs)}),M=r=>Object.fromEntries(r.map(e=>[e.name,or(e)])),Tr=r=>Object.fromEntries(r.map(e=>[e.command,{desc:e.desc,text:e.text,args:M(e.args)}])),Nr=r=>Object.fromEntries(r.map(e=>[e.name,{params:M(e.params)}]));exports.isRmmzDataKind=K.isRmmzDataKind,exports.lookupKind=K.lookupKind,exports.classifyFileParams=r=>w(r,e=>e.attr.kind==="file",e=>e.attr.kind==="file[]"),exports.classifyPluginParams=r=>w(r,e=>!0,e=>!0),exports.classifyTextParams=r=>w(r,e=>O(e),e=>O(e)),exports.collectDependentStructNames=rr,exports.compileAttributes=or,exports.convertPluginCommandSchema=r=>({...pr.textAndDesc(r),command:r.command,args:j(r.args)}),exports.convertStructSchema=r=>({struct:r.struct,params:j(r.params)}),exports.createStructMap=r=>new Map(r.map(e=>[e.struct,e.params.map(t=>t.attr)])),exports.filterPluginSchemaByFileParam=r=>P(r,q),exports.filterPluginSchemaByNumberParam=r=>P(r,R),exports.filterPluginSchemaByParam=P,exports.filterPluginSchemaByStringParam=r=>P(r,O),exports.filterPluginSchemaByVariableParam=r=>P(r,Z),exports.hasNumberValueParam=r=>x(r)?J(r):W(r),exports.hasStructAttr=D,exports.hasTextAttr=O,exports.isArrayAttr=Y,exports.isArrayParam=x,exports.isArrayParamEx=(r,e)=>!!x(r)&&r.kind===`${e}[]`,exports.isFileAttr=q,exports.isNumberArrayParam=J,exports.isNumberAttr=R,exports.isNumberValueParam=W,exports.isNumberValueParamEx=X,exports.isScalarParam=G,exports.isStringArrayParam=r=>y[r.kind.replace("[]","")].type==="string",exports.isStringValueParam=r=>y[r.kind].type==="string",exports.isStructArrayAttr=Q,exports.isStructArrayParam=L,exports.isStructParam=N,exports.isVariableAttr=Z,exports.paramHasText=r=>{var e;return((e=y[r.kind])==null?void 0:e.hasText)===!0},exports.pluginSourceToJSON=r=>(e=>Sr(Or(e)))(r),exports.rebuildCommands=er,exports.structDependencies=(r,e)=>tr(r,e,new Set),exports.toArrayPluginParam=r=>Object.entries(r).map(([e,t])=>({name:e,attr:t})),exports.toObjectPluginParams=j;
