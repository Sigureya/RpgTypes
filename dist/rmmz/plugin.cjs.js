"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("../shared/lookupRpgDataKind.cjs.js"),_=(t,e)=>{const r=function(a){return Object.fromEntries(a.map(n=>[n.struct,n.params.filter(s.hasStructAttr)]))}(t);return function(a,n,c){return a.reduce(o=>{if(!o.changed)return o;const u=a.filter(P=>!o.names.has(P)&&n[P].some(i=>o.names.has(i.attr.struct)));return u.length===0?{names:o.names,changed:!1}:{names:new Set([...o.names,...u]),changed:!0}},{names:c,changed:!0}).names}(Object.keys(r),r,new Set(e))},b=(t,e)=>{const r=t.structs.filter(c=>c.params.some(o=>e(o))),a=new Set(r.map(c=>c.struct)),n=_(t.structs,a);return{structs:U(t.structs,n,e),commands:L(t.commands,n,e),params:T(t.params,n,e)}},T=(t,e,r)=>t.filter(a=>s.hasStructAttr(a)?e.has(a.attr.struct):r(a)),U=(t,e,r)=>t.reduce((a,n)=>{const c=T(n.params,e,r);return c.length===0||a.push({struct:n.struct,params:c}),a},[]),L=(t,e,r)=>t.reduce((a,n)=>{const c=T(n.args,e,r);return c.length===0||a.push({...n.desc?{desc:n.desc}:{},...n.text?{text:n.text}:{},command:n.command,args:c}),a},[]),O=(t,e,r)=>{const a=[],n=[],c=[],o=[];return t.forEach(u=>{if(s.isStructParam(u.attr))a.push({name:u.name,attr:u.attr});else if(s.isStructArrayAttr(u))n.push(u);else if(s.isArrayAttr(u)){if(r(u))return void o.push(u)}else e(u)&&c.push(u)}),{structs:a,structArrays:n,scalas:c,scalaArrays:o}},D=(t,e,r)=>{const a=e.get(t);return a?a.filter(n=>((c,o)=>!(!s.isStructParam(c)&&!s.isStructArrayParam(c)||!c.struct||o.has(c.struct)))(n,r)).flatMap(n=>{const c=n.struct;return r.add(c),[c,...D(c,e,r)]}):[]},I=(t,e)=>Object.entries(e).reduce((r,[a,n])=>{if(a in t){const c=t[a];if(typeof c=="string")return{...r,[a]:n(c)}}return r},{}),f=(t,e,r,a)=>({default:e,...I(r,a),kind:t}),y=(t,e,r)=>({default:[],...I(e,r),kind:t}),M="BODY",z="STRUCT",A="NONE",Y=(t,e)=>{const r=t.lines.length>0?j(t):t,a=e[1]||void 0;return{...r,structName:a,blockType:a?z:"INVALID",locale:e[2],lines:[]}},$=t=>({...t.lines.length>0?j(t):t,blockType:M,structName:void 0,locale:void 0,lines:[]}),j=t=>t.blockType===M?{...t,bodies:t.bodies.concat([{lines:[...t.lines]}]),lines:[],blockType:A}:t.structName&&t.blockType===z?{...t,structs:t.structs.concat([{struct:t.structName,locale:t.locale,lines:[...t.lines]}]),blockType:A,structName:void 0,locale:void 0,lines:[]}:{...t,blockType:A,structName:void 0,lines:[]},G=t=>t.currentOption?{items:t.items.concat({option:t.currentOption,value:t.currentOption})}:t,K="help",N="kind",C="text",E="struct",J=t=>{const e=JSON.parse(t);return Array.isArray(e)?e.map(S):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([r,a])=>[r,S(a)])):e},S=t=>{if(typeof t!="string")return t;try{const e=JSON.parse(t);return Array.isArray(e)?e.map(S):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([r,a])=>[r,S(a)])):e}catch{return t}},R=t=>{if(N in t.attr){const e=Q[t.attr.kind];if(e)return e(t)}return f("any","",t.attr,x)},m=t=>t,W=t=>t.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),x={default:m,text:m,desc:m,parent:m},V=t=>f("string","",t.attr,x),F=t=>{const e={default:r=>J(r),text:m,desc:m,parent:m};return y("string[]",t.attr,e)},l=(t,e)=>{const r={default:W,text:m,desc:m,parent:m};return y(e,t.attr,r)},d=(t,e)=>{const r={default:a=>parseInt(a,10),text:m,desc:m,parent:m};return f(e,0,t.attr,r)},Q={number:t=>(e=>{const r={default:a=>parseFloat(a),text:m,desc:m,decimals:a=>parseInt(a,10),min:a=>parseFloat(a),max:a=>parseFloat(a),parent:m};return f("number",0,e.attr,r)})(t),"number[]":t=>{const e={default:W,text:m,desc:m,decimals:r=>parseInt(r,10),min:r=>parseFloat(r),max:r=>parseFloat(r),parent:m};return y("number[]",t.attr,e)},string:V,"string[]":F,multiline_string:V,"multiline_string[]":F,combo:t=>{var r;const e=((r=t.options)==null?void 0:r.map(a=>a.option))??[];return{...f("combo","",t.attr,x),options:e}},select:t=>{var r;const e=((r=t.options)==null?void 0:r.map(a=>({option:a.option,value:a.value})))??[];return{...f("select","",t.attr,x),options:e}},actor:t=>d(t,"actor"),"actor[]":t=>l(t,"actor[]"),class:t=>d(t,"class"),"class[]":t=>l(t,"class[]"),skill:t=>d(t,"skill"),"skill[]":t=>l(t,"skill[]"),item:t=>d(t,"item"),"item[]":t=>l(t,"item[]"),weapon:t=>d(t,"weapon"),"weapon[]":t=>l(t,"weapon[]"),armor:t=>d(t,"armor"),"armor[]":t=>l(t,"armor[]"),state:t=>d(t,"state"),"state[]":t=>l(t,"state[]"),enemy:t=>d(t,"enemy"),"enemy[]":t=>l(t,"enemy[]"),common_event:t=>d(t,"common_event"),"common_event[]":t=>l(t,"common_event[]"),switch:t=>d(t,"switch"),"switch[]":t=>l(t,"switch[]"),variable:t=>d(t,"variable"),"variable[]":t=>l(t,"variable[]"),troop:t=>d(t,"troop"),"troop[]":t=>l(t,"troop[]"),boolean:t=>{const e={default:r=>r==="true",text:m,desc:m,on:m,off:m,parent:m};return f("boolean",!0,t.attr,e)},file:t=>{const e={default:m,text:m,desc:m,parent:m,dir:m};return{dir:"",...f("file","",t.attr,e)}},"file[]":t=>{const e={default:r=>J(r),text:m,desc:m,parent:m,dir:m};return{dir:"",...y("file[]",t.attr,e)}}},k=t=>({...typeof t.desc=="string"?{desc:t.desc}:{},...typeof t.text=="string"?{text:t.text}:{}}),g=t=>{const e=X(t),r=et(e);return tt(r)},X=t=>{if(t.currentParam&&t.currentOption){const e=t.currentParam.attr.kind;if(e==="select"||e==="combo")return{...t,currentParam:{...t.currentParam,options:G(t.currentOption).items}}}return t},tt=t=>t.currentParam?{...t,params:[...t.params,t.currentParam],currentParam:null,currentContext:null}:t,et=t=>{if(!t.currentCommand)return t;const e=t.currentParam?[...t.currentCommand.args,t.currentParam]:t.currentCommand.args,r={...k(t.currentCommand),command:t.currentCommand.command,args:e};return{...t,commands:[...t.commands,r],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},rt=t=>{const e=(c=>{const o=c.split(`
`),u={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:A},P=o.reduce((i,q)=>{const h=q.trim(),w=h.match(/^\/\*~struct~([A-Za-z0-9_]+)(?::([A-Za-z0-9_-]+))?/);return w?Y(i,w):h==="/*:"?$(i):h==="*/"?i.lines.length>0?j(i):i:{...i,lines:i.lines.concat([h])}},u);return{structs:P.structs,bodies:P.bodies}})(t),r=e.structs.map(c=>at(c)),a=nt(e);if(!a)return{params:[],commands:[],meta:{},helpLines:[],structs:r};const n=Z(a,H);return{params:n.params,commands:n.commands,meta:n.meta,helpLines:n.helpLines,structs:r}},at=t=>{const e=Z(t,H);return{name:t.struct,params:e.params}},nt=t=>{if(t.bodies.length!==0)return t.bodies[0]},Z=(t,e)=>{const r=t.lines.reduce((a,n)=>{const c=n.trimEnd().replace(/^[\*\s]*/,"");if(!c.startsWith("@"))return a.currentContext===K?{...a,helpLines:a.helpLines.concat(c)}:a;const o=c.match(/^@(\S+)\s*(.*)$/);if(!o)return a;const[,u,P]=o,i=e[u];return i?i(a,P.trim()):a},st());return g(r)},st=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),p=(t,e,r)=>t.currentParam&&!(e in t.currentParam.attr)?{...t,currentParam:{...t.currentParam,attr:{...t.currentParam.attr,[e]:r}}}:t,v=(t,e,r)=>({...t,meta:{[e]:r,...t.meta}}),H={param:(t,e)=>{const r=g(t);return r.params.some(a=>a.name===e)?r:{...r,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(t,e)=>t.currentParam?p(t,C,e):t.currentCommand&&!(C in t.currentCommand)?{...t,currentCommand:{...k(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args,[C]:e}}:t,desc:(t,e)=>t.currentParam?p(t,"desc",e):t.currentCommand?{...t,currentCommand:{...t.currentCommand,desc:e}}:t,command:(t,e)=>{const r=g(t);return r.commands.some(a=>a.command===e)?r:{...r,currentCommand:{command:e,args:[]},currentParam:null}},arg:(t,e)=>{if(!t.currentCommand)return t;if(!t.currentParam)return{...t,currentParam:{name:e,attr:{}}};const r={...k(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args.concat(t.currentParam)};return{...t,commands:t.commands,currentCommand:r,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:t=>({...g(t),currentContext:K}),option:(t,e)=>{if(!t.currentParam)return t;const r=((a,n)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:a.currentOption}),currentOption:n}:{items:a.items,currentOption:n})(t.currentOption??{items:[]},e);return{...t,currentOption:r}},value:(t,e)=>{if(!t.currentOption)return t;const r=((a,n)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:n})}:{items:a.items})(t.currentOption,e);return{...t,currentOption:r}},type:(t,e)=>{if((r=>r.endsWith(">")&&r.startsWith("struct<"))(e)){const r=e.slice(7,-1),a=p(t,E,r);return p(a,N,E)}return t.currentParam?p(t,N,e):t},default:(t,e)=>p(t,"default",e),on:(t,e)=>p(t,"on",e),off:(t,e)=>p(t,"off",e),min:(t,e)=>p(t,"min",e),max:(t,e)=>p(t,"max",e),base:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{orderAfter:r.orderAfter,orderBefore:r.orderBefore,base:r.base.concat(a)})};var r,a},orderAfter:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{base:r.base,orderBefore:r.orderBefore,orderAfter:r.orderAfter.concat(a)})};var r,a},orderBefore:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{base:r.base,orderAfter:r.orderAfter,orderBefore:r.orderBefore.concat(a)})};var r,a},author:(t,e)=>v(t,"author",e),plugindesc:(t,e)=>v(t,"plugindesc",e),url:(t,e)=>v(t,"url",e)},ct=t=>({target:"MZ",meta:t.meta,commands:mt(t.commands),params:B(t.params),structs:ot(t.structs)}),B=t=>Object.fromEntries(t.map(e=>[e.name,R(e)])),mt=t=>Object.fromEntries(t.map(e=>[e.command,{desc:e.desc,text:e.text,args:B(e.args)}])),ot=t=>Object.fromEntries(t.map(e=>[e.name,{params:B(e.params)}]));exports.convertPluginCommandSchema=s.convertPluginCommandSchema,exports.convertStructSchema=s.convertStructSchema,exports.hasNumberValueParam=s.hasNumberValueParam,exports.hasStructAttr=s.hasStructAttr,exports.hasTextAttr=s.hasTextAttr,exports.isArrayAttr=s.isArrayAttr,exports.isArrayParam=s.isArrayParam,exports.isArrayParamEx=s.isArrayParamEx,exports.isFileAttr=s.isFileAttr,exports.isNumberArrayParam=s.isNumberArrayParam,exports.isNumberAttr=s.isNumberAttr,exports.isNumberValueParam=s.isNumberValueParam,exports.isNumberValueParamEx=s.isNumberValueParamEx,exports.isRmmzDataKind=s.isRmmzDataKind,exports.isScalarParam=s.isScalarParam,exports.isStringArrayParam=s.isStringArrayParam,exports.isStringValueParam=s.isStringValueParam,exports.isStructArrayAttr=s.isStructArrayAttr,exports.isStructArrayParam=s.isStructArrayParam,exports.isStructParam=s.isStructParam,exports.isVariableAttr=s.isVariableAttr,exports.lookupKind=s.lookupKind,exports.paramHasText=s.paramHasText,exports.toArrayPluginParam=s.toArrayPluginParam,exports.toObjectPluginParams=s.toObjectPluginParams,exports.classifyFileParams=t=>O(t,e=>e.attr.kind==="file",e=>e.attr.kind==="file[]"),exports.classifyPluginParams=t=>O(t,e=>!0,e=>!0),exports.classifyTextParams=t=>O(t,e=>s.hasTextAttr(e),e=>s.hasTextAttr(e)),exports.collectDependentStructNames=_,exports.compileAttributes=R,exports.createStructMap=t=>new Map(t.map(e=>[e.struct,e.params.map(r=>r.attr)])),exports.filterPluginSchemaByFileParam=t=>b(t,s.isFileAttr),exports.filterPluginSchemaByNumberParam=t=>b(t,s.isNumberAttr),exports.filterPluginSchemaByParam=b,exports.filterPluginSchemaByStringParam=t=>b(t,s.hasTextAttr),exports.filterPluginSchemaByVariableParam=t=>b(t,s.isVariableAttr),exports.pluginSourceToJSON=t=>(e=>ct(rt(e)))(t),exports.rebuildCommands=L,exports.structDependencies=(t,e)=>D(t,e,new Set);
